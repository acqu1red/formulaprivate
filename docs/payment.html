<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û–ø–ª–∞—Ç–∞ ‚Äî MiniApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg:#0f1115; --card:#171923; --text:#e8e8ef; --muted:#a6a8ad;
      --brand:#d6c7b8; --accent:#c4a98a; --danger:#ef4444; --ok:#22c55e;
      --radius:16px;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; font: 16px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial;
      color: var(--text); background: radial-gradient(1200px 600px at 50% -80px,#202437 0%,#0f1115 50%);
      min-height: 100dvh; display: grid; place-items: start center; padding: 24px;
    }
    .wrap { width: 100%; max-width: 760px; }
    .card {
      background: linear-gradient(180deg, #181b26 0%, #131621 100%);
      border: 1px solid #25293a; border-radius: var(--radius); padding: 20px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
    }
    h1 { font-size: 22px; margin: 0 0 14px; }
    p.lead { margin: 0 0 18px; color: var(--muted) }
    .grid { display: grid; gap: 12px; }
    .grid.cols-1 { grid-template-columns: 1fr; }
    .grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
    .opt {
      position: relative; border:1px solid #2a2e45; border-radius: 14px; padding: 12px; cursor: pointer;
      transition: .2s transform, .2s border-color, .2s box-shadow, .2s background;
      background: #121524;
    }
    .opt:hover { transform: translateY(-2px); border-color:#3a4062; }
    .opt input { display:none; }
    .opt .title { font-weight: 600; }
    .opt .sub { color: var(--muted); font-size: 13px; }
    .opt .price { margin-top: 6px; font-size: 18px; color: var(--brand); }
    .opt.active { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(196,169,138,.2) inset; background:#161a2b; }
    .field { display: grid; gap: 6px; }
    .field label { font-weight:600; }
    .input {
      width: 100%; padding: 12px 14px; background: #0e1220; color: var(--text);
      border: 1px solid #2a2e45; border-radius: 12px; outline: none;
    }
    .input:focus { border-color:#3a4062; }
    .hint { color: var(--muted); font-size: 13px; }
    .error { color: var(--danger); font-size: 13px; display:none; }
    .banner {
      display:none; padding: 10px 12px; border-radius: 12px; margin-bottom:12px;
      border:1px solid rgba(255,255,255,.08);
    }
    .banner.ok { background: rgba(34,197,94,.08); border-color: rgba(34,197,94,.25); color:#bbf7d0; }
    .banner.err{ background: rgba(239,68,68,.08); border-color: rgba(239,68,68,.25); color:#fecaca; }
    .total {
      display:flex; align-items:center; justify-content:space-between; padding:12px 14px;
      border:1px dashed #2a2e45; border-radius: 12px; background: #0e1220; margin-top: 6px;
    }
    .btn {
      width:100%; padding: 14px 16px; border:0; border-radius: 12px; cursor:pointer;
      background: linear-gradient(90deg, #cdb89d, #bca185); color:#0b0d14; font-weight:700;
      box-shadow: 0 8px 24px rgba(198,178,150,.25);
      transition: .2s transform, .2s opacity;
    }
    .btn[disabled]{ opacity:.4; cursor:not-allowed; }
    .btn:active { transform: translateY(1px); }
    .foot { margin-top: 12px; color: var(--muted); font-size: 12px; text-align:center; }
    .row { display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width:720px){ .row { grid-template-columns: 1fr 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="bannerOk" class="banner ok">–ì–æ—Ç–æ–≤–æ. –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç–∞.</div>
    <div id="bannerErr" class="banner err">–û—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.</div>

    <div class="card grid">
      <div>
        <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞</h1>
        <p class="lead">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ, —É–∫–∞–∂–∏—Ç–µ e‚Äëmail –¥–ª—è —á–µ–∫–∞ –∏ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏—à–ª—ë—Ç —Å—Å—ã–ª–∫—É –≤ –∑–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª.</p>
      </div>

      <div class="grid">
        <div class="field">
          <label>–¢–∞—Ä–∏—Ñ</label>
          <div id="tariffs" class="grid cols-1">
            <label class="opt" data-price="490" data-tariff="basic">
              <input type="radio" name="tariff" value="basic">
              <div class="title">–ë–∞–∑–æ–≤—ã–π</div>
              <div class="sub">30 –¥–Ω–µ–π</div>
              <div class="price">490 ‚ÇΩ</div>
            </label>
          </div>
          <div class="error" id="errTariff">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ</div>
        </div>

        <div class="row">
          <div class="field">
            <label>E‚Äëmail –¥–ª—è —á–µ–∫–∞</label>
            <input id="email" class="input" type="email" placeholder="you@example.com" inputmode="email" autocomplete="email" />
            <div class="error" id="errEmail">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π e‚Äëmail</div>
            <div class="hint">–ú—ã –Ω–µ —Å–ø–∞–º–∏–º. E‚Äëmail –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —á–µ–∫–∞.</div>
          </div>
          <div class="field">
            <label>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
            <div class="grid cols-3" id="banks">
              <label class="opt" data-bank="russian"><input type="radio" name="bank" value="russian"><div class="title">üá∑üá∫ –ë–∞–Ω–∫ –†–§</div></label>
              <label class="opt" data-bank="foreign"><input type="radio" name="bank" value="foreign"><div class="title">üåç –ó–∞—Ä—É–±–µ–∂–Ω—ã–π</div></label>
              <label class="opt" data-bank="crypto"><input type="radio" name="bank" value="crypto"><div class="title">‚Çø –ö—Ä–∏–ø—Ç–æ</div></label>
            </div>
            <div class="error" id="errBank">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</div>
          </div>
        </div>

        <div class="total">
          <div>–ö –æ–ø–ª–∞—Ç–µ</div>
          <div><b id="total">‚Äî</b></div>
        </div>

        <button id="pay" class="btn" disabled>–û–ø–ª–∞—Ç–∏—Ç—å</button>
        <div class="foot">–ù–∞–∂–∏–º–∞—è ¬´–û–ø–ª–∞—Ç–∏—Ç—å¬ª, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –æ—Ñ–µ—Ä—Ç–æ–π. –û–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ LAVA.</div>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.expand(); tg.ready(); }

    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));

    const state = { tariff:null, price:0, email:"", bank:null, userId:null };

    function money(n){ try{ return new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:0}).format(n); }catch(e){ return n + ' ‚ÇΩ'; } }
    function show(el){ el.style.display='block'; }
    function hide(el){ el.style.display='none'; }

    function validate(){
      let ok = true;

      // tariff
      if (!state.tariff) { show($('#errTariff')); ok=false; } else hide($('#errTariff'));

      // email
      const emailVal = $('#email').value.trim();
      state.email = emailVal;
      const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(emailVal);
      if (!emailOk) { show($('#errEmail')); ok=false; } else hide($('#errEmail'));

      // bank
      if (!state.bank) { show($('#errBank')); ok=false; } else hide($('#errBank'));

      $('#pay').disabled = !ok;
      return ok;
    }

    function recalc(){
      $('#total').textContent = state.price ? money(state.price) : '‚Äî';
      validate();
    }

    function initSelections(){
      // Tariffs
      $$('#tariffs .opt').forEach(opt => {
        opt.addEventListener('click', () => {
          $$('#tariffs .opt').forEach(o => o.classList.remove('active'));
          opt.classList.add('active');
          const price = parseInt(opt.dataset.price, 10);
          const tariff = opt.dataset.tariff;
          state.tariff = tariff; state.price = isNaN(price)?0:price;
          recalc();
        });
      });

      // Banks
      $$('#banks .opt').forEach(opt => {
        opt.addEventListener('click', () => {
          $$('#banks .opt').forEach(o => o.classList.remove('active'));
          opt.classList.add('active');
          state.bank = opt.dataset.bank;
          recalc();
        });
      });

      $('#email').addEventListener('input', validate);
    }

    function params(){
      const q = new URLSearchParams(location.search);
      return Object.fromEntries(q.entries());
    }

    async function createPaymentIfAPI(payload){
      const p = params();
      if (!p.api) return null; // optional: direct API call only if ?api=... is provided
      try{
        const res = await fetch(p.api.replace(/\/$/, '') + '/api/create-payment', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data?.ok && data.payment_url){
          if (tg?.openLink) tg.openLink(data.payment_url);
          else window.open(data.payment_url, '_blank');
          return data.payment_url;
        }
        throw new Error(data?.error || 'API error');
      }catch(e){
        console.error('Direct API error', e);
        return null;
      }
    }

    async function pay(){
      if (!validate()) return;

      // prepare payload
      const payload = {
        price: state.price,
        email: state.email,
        tariff: state.tariff,
        bank: state.bank,
        userId: state.userId || undefined
      };

      // 1) send to bot (required path)
      try {
        tg?.sendData?.(JSON.stringify(payload));
        show($('#bannerOk')); hide($('#bannerErr'));
      } catch(e){
        console.error('sendData error', e);
        show($('#bannerErr')); hide($('#bannerOk'));
      }

      // 2) optional: call server directly when ?api=... provided
      await createPaymentIfAPI(payload);
    }

    function boot(){
      // read user id from Telegram
      try{
        state.userId = tg?.initDataUnsafe?.user?.id || null;
      }catch{}
      initSelections();
      recalc();
      $('#pay').addEventListener('click', pay);

      // Prefill via URL (?tariff=pro&email=x&bank=crypto)
      const p = params();
      if (p.email) { $('#email').value = p.email; }
      if (p.tariff) {
        const t = document.querySelector(`[data-tariff="${p.tariff}"]`);
        t?.click();
      }
      if (p.bank) {
        const b = document.querySelector(`[data-bank="${p.bank}"]`);
        b?.click();
      }
      if (p.price) {
        const pr = parseInt(p.price, 10);
        if (!isNaN(pr)) { state.price = pr; recalc(); }
      }
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
