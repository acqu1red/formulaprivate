<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>Оплата — Мини-приложение</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

  * {
    box-sizing: border-box;
  }
  
  body {
    margin: 0;
    background: #121212;
    font-family: 'Inter', sans-serif;
    color: #f0eadf;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  /* Header styles */
  header {
    background: #1f1f1f;
    padding: 16px 0;
    text-align: center;
    position: relative;
    border: 2px solid #d6c7b8;
    border-radius: 12px;
    margin: 12px 16px 8px 16px;
    flex-shrink: 0;
  }
  
  header h1 {
    margin: 0;
    font-weight: 600;
    font-size: 1.4rem;
    color: #f0eadf;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
  }

  header svg {
    width: 30px;
    height: 30px;
    vertical-align: middle;
    filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.7));
  }

  /* Main content area */
  main {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    padding: 0 16px;
  }

  /* Step container */
  .step-container {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    padding: 20px 0;
  }

  .step {
    display: none;
    flex-direction: column;
    gap: 24px;
    animation: fadeInUp 0.4s ease-out;
  }

  .step.active {
    display: flex;
  }

  .step.active .tariff-title-block {
    animation: tariffTitleGlow 2s ease-in-out infinite alternate, fadeInUp 0.6s ease-out;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Content blocks */
  .content-block {
    background: linear-gradient(135deg, #1f1f1f 0%, #1a1a1a 100%);
    border: 2px solid #333;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
  }

  .content-block:hover {
    border-color: #d6c7b8;
    box-shadow: 0 12px 40px rgba(214, 199, 184, 0.1);
  }

  /* Tariff title block */
  .tariff-title-block {
    background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
    border: 3px solid #d6c7b8;
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
    animation: tariffTitleGlow 2s ease-in-out infinite alternate;
    box-shadow: 0 8px 25px rgba(214, 199, 184, 0.2);
  }

  .tariff-title-block::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(214, 199, 184, 0.1), transparent);
    animation: tariffTitleShimmer 3s ease-in-out infinite;
  }

  .tariff-title-block::after {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100px;
    height: 100px;
    background: radial-gradient(circle, rgba(214, 199, 184, 0.1) 0%, transparent 70%);
    border-radius: 50%;
    animation: tariffTitlePulse 4s ease-in-out infinite;
  }

  @keyframes tariffTitleGlow {
    0% {
      box-shadow: 0 8px 25px rgba(214, 199, 184, 0.2);
      border-color: #d6c7b8;
    }
    100% {
      box-shadow: 0 12px 35px rgba(214, 199, 184, 0.4);
      border-color: #f0eadf;
    }
  }

  @keyframes tariffTitleShimmer {
    0% {
      left: -100%;
    }
    100% {
      left: 100%;
    }
  }

  @keyframes tariffTitlePulse {
    0%, 100% {
      transform: scale(1);
      opacity: 0.3;
    }
    50% {
      transform: scale(1.2);
      opacity: 0.6;
    }
  }

  .tariff-title-text {
    font-size: 1.3rem;
    font-weight: 700;
    color: #f0eadf;
    text-align: center;
    margin: 0;
    position: relative;
    z-index: 2;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    animation: tariffTitleText 2s ease-in-out infinite alternate;
  }

  @keyframes tariffTitleText {
    0% {
      transform: scale(1);
      color: #f0eadf;
    }
    100% {
      transform: scale(1.02);
      color: #d6c7b8;
    }
  }

  .tariff-badge {
    position: absolute;
    top: -10px;
    right: -10px;
    background: linear-gradient(135deg, #d6c7b8 0%, #f0eadf 100%);
    color: #121212;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(214, 199, 184, 0.4);
    animation: tariffBadgeBounce 2s ease-in-out infinite;
  }

  @keyframes tariffBadgeBounce {
    0%, 100% {
      transform: translateY(0) scale(1);
    }
    50% {
      transform: translateY(-5px) scale(1.05);
    }
  }

  .content-text {
    font-size: 1.1rem;
    line-height: 1.6;
    color: #f0eadf;
    margin-bottom: 20px;
  }

  .content-text strong {
    color: #d6c7b8;
    font-weight: 600;
  }

  .content-text em {
    color: #a6a8ad;
    font-style: italic;
  }

  /* Tariff selection */
  .tariff-grid {
    display: grid;
    gap: 16px;
    margin-top: 20px;
  }

  .tariff-option {
    background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
    border: 2px solid #444;
    border-radius: 16px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .tariff-option::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(214, 199, 184, 0.1), transparent);
    transition: left 0.6s ease;
  }

  .tariff-option:hover::before {
    left: 100%;
  }

  .tariff-option:hover {
    border-color: #d6c7b8;
    transform: translateY(-4px);
    box-shadow: 0 12px 30px rgba(214, 199, 184, 0.2);
  }

  .tariff-option:active {
    transform: translateY(-2px);
  }

  .tariff-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .tariff-name {
    font-size: 1.2rem;
    font-weight: 600;
    color: #f0eadf;
  }

  .tariff-price {
    background: linear-gradient(135deg, #d6c7b8 0%, #f0eadf 100%);
    color: #121212;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 1rem;
    box-shadow: 0 4px 15px rgba(214, 199, 184, 0.3);
  }

  .tariff-description {
    color: #a6a8ad;
    font-size: 0.9rem;
    line-height: 1.4;
  }

  /* Payment method selection */
  .payment-methods {
    display: grid;
    gap: 16px;
    margin-top: 20px;
  }

  .payment-method {
    background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
    border: 2px solid #444;
    border-radius: 16px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .payment-method:hover {
    border-color: #d6c7b8;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(214, 199, 184, 0.2);
  }

  .payment-method:active {
    transform: translateY(0);
  }

  .payment-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #d6c7b8 0%, #f0eadf 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: #121212;
    flex-shrink: 0;
  }

  .payment-info {
    flex-grow: 1;
  }

  .payment-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: #f0eadf;
    margin-bottom: 4px;
  }

  .payment-description {
    color: #a6a8ad;
    font-size: 0.9rem;
  }

  /* Form styles */
  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    font-size: 1rem;
    font-weight: 600;
    color: #f0eadf;
    margin-bottom: 8px;
  }

  .form-input {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
    border: 2px solid #444;
    border-radius: 12px;
    color: #f0eadf;
    font-size: 1rem;
    transition: all 0.3s ease;
    outline: none;
  }

  .form-input:focus {
    border-color: #d6c7b8;
    box-shadow: 0 0 0 3px rgba(214, 199, 184, 0.1);
  }

  .form-input::placeholder {
    color: #a6a8ad;
  }

  /* Bank selection */
  .bank-options {
    display: grid;
    gap: 12px;
    margin-top: 16px;
  }

  .bank-option {
    background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
    border: 2px solid #444;
    border-radius: 12px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    font-weight: 600;
    color: #f0eadf;
  }

  .bank-option:hover {
    border-color: #d6c7b8;
    background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
  }

  .bank-option.selected {
    border-color: #d6c7b8;
    background: linear-gradient(135deg, #d6c7b8 0%, #f0eadf 100%);
    color: #121212;
  }

  /* Summary styles */
  .summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #333;
  }

  .summary-item:last-child {
    border-bottom: none;
    font-weight: 600;
    color: #d6c7b8;
    font-size: 1.1rem;
  }

  .summary-label {
    color: #a6a8ad;
  }

  .summary-value {
    color: #f0eadf;
    font-weight: 500;
  }

  /* Button styles */
  .button-group {
    display: grid;
    gap: 12px;
    margin-top: 24px;
  }

  .btn {
    padding: 16px 24px;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-primary {
    background: linear-gradient(135deg, #d6c7b8 0%, #f0eadf 100%);
    color: #121212;
    box-shadow: 0 4px 15px rgba(214, 199, 184, 0.3);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(214, 199, 184, 0.4);
  }

  .btn-secondary {
    background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
    color: #f0eadf;
    border: 2px solid #444;
  }

  .btn-secondary:hover {
    border-color: #d6c7b8;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(214, 199, 184, 0.2);
  }

  .btn:active {
    transform: translateY(0);
  }

  /* Link button styles */
  .btn[href] {
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .btn[href]:hover {
    text-decoration: none;
  }

  /* Progress indicator */
  .progress-bar {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 24px;
  }

  .progress-step {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #444;
    transition: all 0.3s ease;
  }

  .progress-step.active {
    background: #d6c7b8;
    transform: scale(1.2);
  }

  .progress-step.completed {
    background: #4CAF50;
  }

  /* Responsive design */
  @media (max-width: 480px) {
    .content-block {
      padding: 20px;
    }
    
    .tariff-option {
      padding: 16px;
    }
    
    .payment-method {
      padding: 16px;
    }
    
    .btn {
      padding: 14px 20px;
    }
  }

  /* Scrollbar styles */
  .step-container::-webkit-scrollbar {
    width: 6px;
  }
  
  .step-container::-webkit-scrollbar-track {
    background: #1f1f1f;
  }
  
  .step-container::-webkit-scrollbar-thumb {
    background: #d6c7b8;
    border-radius: 3px;
  }
</style>
</head>
<body>
<header>
  <h1>
    💳 Оплата доступа
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
      <line x1="1" y1="10" x2="23" y2="10"/>
    </svg>
  </h1>
</header>

<main>
  <div class="step-container">
    <!-- Step 1: Tariff Selection -->
    <div class="step active" id="step1">
      <div class="progress-bar">
        <div class="progress-step active"></div>
        <div class="progress-step"></div>
        <div class="progress-step"></div>
        <div class="progress-step"></div>
      </div>
      
      <div class="content-block">
        <div class="content-text">
          Ты сделал верный выбор.
        </div>
        <div class="content-text">
          Выбери тариф по стоимости подписки на Формулу:
        </div>
      </div>

      <div class="tariff-grid">
        <div class="tariff-option" data-tariff="1_month" data-price="50">
          <div class="tariff-header">
            <div class="tariff-name">1 месяц</div>
            <div class="tariff-price">50 ₽</div>
          </div>
          <div class="tariff-description">Базовый доступ к закрытому каналу</div>
        </div>
        

      </div>

      <div class="content-block">
        <div class="content-text">
          <em>*цена в долларах/евро - конвертируется по нынешнему курсу</em><br>
          <em>*оплачивай любой картой в долларах/евро/рублях, бот сконвертирует сам</em>
        </div>
      </div>
    </div>

    <!-- Step 2: Payment Method Selection -->
    <div class="step" id="step2">
      <div class="progress-bar">
        <div class="progress-step completed"></div>
        <div class="progress-step active"></div>
        <div class="progress-step"></div>
        <div class="progress-step"></div>
      </div>
      
      <div class="tariff-title-block">
        <div class="tariff-badge">ВЫБРАН</div>
        <div class="tariff-title-text" id="selectedTariffTitle">ЗАКРЫТЫЙ КАНАЛ "ОСНОВА" на 1 месяц</div>
      </div>
      
      <div class="content-block">
        <div class="content-text">
          <em>*если вы из Украины, включите vpn</em><br>
          <em>*при оплате картой — оформляется автосписание каждые 30 дней</em><br>
          <em>*далее — вы сможете управлять подпиской в Меню</em>
        </div>
        <div class="content-text">
          Теперь тебе осталось выбрать удобный вид оплаты:
        </div>
      </div>

      <div class="payment-methods">
        <div class="payment-method" data-method="card">
          <div class="payment-icon">💳</div>
          <div class="payment-info">
            <div class="payment-name">Картой (любая валюта)</div>
            <div class="payment-description">Банковская карта, криптокарта</div>
          </div>
        </div>
        
        <div class="payment-method" data-method="support">
          <div class="payment-icon">💬</div>
          <div class="payment-info">
            <div class="payment-name">Поддержка</div>
            <div class="payment-description">Связаться с поддержкой</div>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button class="btn btn-secondary" onclick="goToStep(1)">Назад</button>
      </div>
    </div>

    <!-- Step 3: Payment Details -->
    <div class="step" id="step3">
      <div class="progress-bar">
        <div class="progress-step completed"></div>
        <div class="progress-step completed"></div>
        <div class="progress-step active"></div>
        <div class="progress-step"></div>
      </div>
      
      <div class="tariff-title-block">
        <div class="tariff-badge">ТОВАР</div>
        <div class="tariff-title-text" id="productName">Канал ФОРМУЛА / 1 мес.</div>
      </div>
      
      <div class="content-block">
        <div class="content-text">
          <strong>Наименование товара</strong><br>
          <span id="productName">Канал ФОРМУЛА / 1 мес.</span>
        </div>
        
        <div class="form-group">
          <label class="form-label">Метод оплаты</label>
          <div class="bank-options">
            <div class="bank-option selected" data-bank="russian">Банк РФ/Зарубежный банк</div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Ваш E-mail: <span style="color: #ff6b6b;">*</span></label>
          <input type="email" class="form-input" id="userEmail" placeholder="example@email.com" required>
        </div>
        
        <div class="content-text">
          <strong>Стоимость</strong><br>
          <span id="finalPrice">50 RUB</span>
        </div>
      </div>

      <div class="button-group">
        <button class="btn btn-primary" onclick="goToStep(4)" id="nextBtn">Далее</button>
        <button class="btn btn-secondary" onclick="goToStep(2)">Назад</button>
      </div>
    </div>

    <!-- Step 4: Confirmation -->
    <div class="step" id="step4">
      <div class="progress-bar">
        <div class="progress-step completed"></div>
        <div class="progress-step completed"></div>
        <div class="progress-step completed"></div>
        <div class="progress-step active"></div>
      </div>
      
      <div class="content-block">
        <div class="content-text">
          Убедитесь, что введённые данные верны:
        </div>
        
        <div class="summary-item">
          <span class="summary-label">Наименование товара</span>
          <span class="summary-value" id="confirmProductName">Канал ФОРМУЛА / 1 мес.</span>
        </div>
        
        <div class="summary-item">
          <span class="summary-label">Метод оплаты</span>
          <span class="summary-value" id="confirmPaymentMethod">Банк РФ</span>
        </div>
        
        <div class="summary-item">
          <span class="summary-label">Ваш E-mail</span>
          <span class="summary-value" id="confirmEmail">example@email.com</span>
        </div>
        
        <div class="summary-item">
          <span class="summary-label">Стоимость</span>
          <span class="summary-value" id="confirmPrice">50 RUB</span>
        </div>
      </div>

      <div class="button-group">
        <button class="btn btn-primary" onclick="generatePaymentLink()">Оплатить</button>
        <button class="btn btn-secondary" onclick="goToStep(3)">Назад</button>
      </div>
    </div>
  </div>
</main>

<script>
// Initialize Telegram WebApp
let tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// Payment state
let paymentState = {
  currentStep: 1,
  selectedTariff: null,
  selectedPaymentMethod: null,
  selectedBank: null,
  userEmail: '',
  prices: {
    '1_month': 50
  },
  tariffNames: {
    '1_month': '1 месяц'
  }
};

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
  initializeApp();
});

function initializeApp() {
  // Tariff selection
  document.querySelectorAll('.tariff-option').forEach(option => {
    option.addEventListener('click', function() {
      const tariff = this.dataset.tariff;
      const price = this.dataset.price;
      
      paymentState.selectedTariff = tariff;
      paymentState.selectedPaymentMethod = null;
      paymentState.selectedBank = null;
      paymentState.userEmail = '';
      
      // Update UI
      document.querySelectorAll('.tariff-option').forEach(opt => opt.style.borderColor = '#444');
      this.style.borderColor = '#d6c7b8';
      
      // Update step 2 content
      document.getElementById('selectedTariffTitle').textContent = 
        `ЗАКРЫТЫЙ КАНАЛ "ОСНОВА" на ${paymentState.tariffNames[tariff]}`;
      
             // Update step 3 content
       const productNameElements = document.querySelectorAll('#productName');
       productNameElements.forEach(element => {
         element.textContent = `Канал ФОРМУЛА / ${paymentState.tariffNames[tariff]}`;
       });
       document.getElementById('finalPrice').textContent = `${price} RUB`;
       
       // Update step 4 content
       document.getElementById('confirmProductName').textContent = `Канал ФОРМУЛА / ${paymentState.tariffNames[tariff]}`;
       document.getElementById('confirmPrice').textContent = `${price} RUB`;
      
      goToStep(2);
    });
  });

  // Payment method selection
  document.querySelectorAll('.payment-method').forEach(method => {
    method.addEventListener('click', function() {
      const methodType = this.dataset.method;
      
             if (methodType === 'support') {
         // Redirect to support page
         tg.openTelegramLink('https://t.me/acqu1red');
         return;
       }
      
      paymentState.selectedPaymentMethod = methodType;
      
      // Update UI
      document.querySelectorAll('.payment-method').forEach(m => m.style.borderColor = '#444');
      this.style.borderColor = '#d6c7b8';
      
      goToStep(3);
    });
  });

  // Bank selection
  document.querySelectorAll('.bank-option').forEach(option => {
    option.addEventListener('click', function() {
      const bank = this.dataset.bank;
      
      paymentState.selectedBank = bank;
      
      // Update UI
      document.querySelectorAll('.bank-option').forEach(opt => opt.classList.remove('selected'));
      this.classList.add('selected');
      
      // Update confirmation
      document.getElementById('confirmPaymentMethod').textContent = 
        bank === 'russian' ? 'Банк РФ' : 'Иностранный банк';
    });
  });

  // Email input
  document.getElementById('userEmail').addEventListener('input', function() {
    paymentState.userEmail = this.value;
    document.getElementById('confirmEmail').textContent = this.value || 'Не указан';
  });

  // Next button validation
  document.getElementById('nextBtn').addEventListener('click', function() {
    // Автоматически устанавливаем метод оплаты
    paymentState.selectedBank = 'russian';
    paymentState.selectedPaymentMethod = 'card';
    
    const email = document.getElementById('userEmail').value;
    if (!email || !email.includes('@')) {
      alert('Пожалуйста, введите корректный email');
      return;
    }
    
    goToStep(4);
  });
}

function goToStep(step) {
  // Hide all steps
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  
  // Show target step
  document.getElementById(`step${step}`).classList.add('active');
  
  // Update progress bar
  updateProgressBar(step);
  
  paymentState.currentStep = step;
}

function updateProgressBar(step) {
  const steps = document.querySelectorAll('.progress-step');
  
  steps.forEach((stepEl, index) => {
    stepEl.classList.remove('active', 'completed');
    
    if (index + 1 < step) {
      stepEl.classList.add('completed');
    } else if (index + 1 === step) {
      stepEl.classList.add('active');
    }
  });
}

function generatePaymentLink() {
  // Автоматически устанавливаем значения если не выбраны
  if (!paymentState.selectedBank) {
    paymentState.selectedBank = 'russian';
  }
  if (!paymentState.selectedPaymentMethod) {
    paymentState.selectedPaymentMethod = 'card';
  }
  
  // Validate required fields
  if (!paymentState.selectedTariff || !paymentState.userEmail) {
    alert('Пожалуйста, заполните все обязательные поля');
    return;
  }
  
  // Prepare payment data
  const paymentData = {
    tariff: paymentState.selectedTariff,
    paymentMethod: paymentState.selectedPaymentMethod,
    bank: paymentState.selectedBank,
    email: paymentState.userEmail,
    price: paymentState.prices[paymentState.selectedTariff],
    userId: tg.initDataUnsafe?.user?.id || 'unknown'
  };
  
  console.log('Payment data:', paymentData);
  
  // Send data to Telegram bot
  tg.sendData(JSON.stringify(paymentData));
  
  // Build Lava Top URL with parameters
  const lavaTopUrl = 'https://app.lava.top/products/1b9f3e05-86aa-4102-9648-268f0f586bb1/302ecdcd-1581-45ad-8353-a168f347b8cc';
  const urlWithParams = new URL(lavaTopUrl);
  
  // Add tariff information to URL parameters
  urlWithParams.searchParams.set('currency', 'RUB');
  urlWithParams.searchParams.set('tariff', paymentState.selectedTariff);
  urlWithParams.searchParams.set('price_rub', paymentState.prices[paymentState.selectedTariff]);
  urlWithParams.searchParams.set('email', paymentState.userEmail);
  urlWithParams.searchParams.set('user_id', paymentData.userId);
  
  // Replace the button with a link button
  const buttonGroup = document.querySelector('#step4 .button-group');
  buttonGroup.innerHTML = `
    <a href="${urlWithParams.toString()}" target="_blank" class="btn btn-primary" style="text-decoration: none; display: flex; align-items: center; justify-content: center;">
      💳 Перейти к оплате
    </a>
    <button class="btn btn-secondary" onclick="goToStep(3)">Назад</button>
  `;
  
  // Show success message
  const successMessage = document.createElement('div');
  successMessage.className = 'content-block';
  successMessage.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
  successMessage.style.borderColor = '#4CAF50';
  successMessage.innerHTML = `
    <div class="content-text" style="color: white; text-align: center;">
      ✅ <strong>Данные подтверждены!</strong><br>
      Нажмите кнопку "Перейти к оплате" для завершения покупки
    </div>
  `;
  
  // Insert success message before button group
  const step4 = document.getElementById('step4');
  const existingSuccess = step4.querySelector('.success-message');
  if (existingSuccess) {
    existingSuccess.remove();
  }
  
  successMessage.classList.add('success-message');
  buttonGroup.parentNode.insertBefore(successMessage, buttonGroup);
}

// Handle back button
window.addEventListener('popstate', function() {
  if (paymentState.currentStep > 1) {
    goToStep(paymentState.currentStep - 1);
  }
});
</script>
</body>
</html>
