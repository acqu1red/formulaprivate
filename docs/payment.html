<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>–û–ø–ª–∞—Ç–∞ ‚Äî –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
  * { box-sizing: border-box; }
  body { margin: 0; background: #121212; font-family: 'Inter', sans-serif; color: #f0eadf;
         display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
  header { background: #1f1f1f; padding: 16px 0; text-align: center; position: relative;
           border: 2px solid #d6c7b8; border-radius: 12px; margin: 12px 16px 8px 16px; flex-shrink: 0; }
  header h1 { margin: 0; font-weight: 600; font-size: 1.4rem; color: #f0eadf;
              display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
  header svg { width: 30px; height: 30px; vertical-align: middle; filter: drop-shadow(0 0 8px rgba(255,255,255,.7)); }
  main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0 16px; }
  .step-container { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; padding: 20px 0; }
  .step { display: none; flex-direction: column; gap: 24px; animation: fadeInUp .4s ease-out; }
  .step.active { display: flex; }
  .step.active .tariff-title-block { animation: tariffTitleGlow 2s ease-in-out infinite alternate, fadeInUp .6s ease-out; }
  @keyframes fadeInUp { from{opacity:0; transform: translateY(20px);} to{opacity:1; transform: translateY(0);} }
  .content-block { background: linear-gradient(135deg, #1f1f1f 0%, #1a1a1a 100%);
                   border: 2px solid #333; border-radius: 16px; padding: 24px;
                   box-shadow: 0 8px 32px rgba(0,0,0,.3); transition: all .3s ease; }
  .content-block:hover { border-color:#d6c7b8; box-shadow:0 12px 40px rgba(214,199,184,.1); }
  .tariff-title-block { background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
                        border:3px solid #d6c7b8; border-radius:20px; padding:20px; margin-bottom:20px; position:relative; overflow:hidden;
                        animation: tariffTitleGlow 2s ease-in-out infinite alternate; box-shadow:0 8px 25px rgba(214,199,184,.2); }
  .tariff-title-block::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
                                background: linear-gradient(90deg, transparent, rgba(214,199,184,.1), transparent);
                                animation: tariffTitleShimmer 3s ease-in-out infinite; }
  .tariff-title-block::after { content:''; position:absolute; top:-50%; right:-50%; width:100px; height:100px;
                               background: radial-gradient(circle, rgba(214,199,184,.1) 0%, transparent 70%);
                               border-radius:50%; animation: tariffTitlePulse 4s ease-in-out infinite; }
  @keyframes tariffTitleGlow { 0%{ box-shadow:0 8px 25px rgba(214,199,184,.2); border-color:#d6c7b8; } 100%{ box-shadow:0 12px 35px rgba(214,199,184,.4); border-color:#f0eadf; } }
  @keyframes tariffTitleShimmer { 0%{left:-100%;} 100%{left:100%;} }
  @keyframes tariffTitlePulse { 0%,100%{ transform:scale(1); opacity:.3;} 50%{ transform:scale(1.2); opacity:.6;} }
  .tariff-title-text { font-size:1.3rem; font-weight:700; color:#f0eadf; text-align:center; margin:0; position:relative; z-index:2; text-shadow:0 2px 4px rgba(0,0,0,.5); animation: tariffTitleText 2s ease-in-out infinite alternate; }
  @keyframes tariffTitleText { 0%{ transform:scale(1); color:#f0eadf;} 100%{ transform:scale(1.02); color:#d6c7b8;} }
  .tariff-badge { position:absolute; top:-10px; right:-10px; background: linear-gradient(135deg, #d6c7b8 0%, #f0eadf 100%); color:#121212; padding:8px 16px; border-radius:20px; font-size:.8rem; font-weight:600; box-shadow:0 4px 15px rgba(214,199,184,.4); animation: tariffBadgeBounce 2s ease-in-out infinite; }
  @keyframes tariffBadgeBounce { 0%,100%{ transform:translateY(0) scale(1);} 50%{ transform:translateY(-5px) scale(1.05);} }
  .content-text { font-size:1.1rem; line-height:1.6; color:#f0eadf; margin-bottom:20px; }
  .content-text em { color:#a6a8ad; font-style:italic; }
  .tariff-grid { display:grid; gap:16px; margin-top:20px; }
  .tariff-option { background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%); border:2px solid #444; border-radius:16px; padding:20px; cursor:pointer; transition:all .3s ease; position:relative; overflow:hidden; }
  .tariff-option::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background: linear-gradient(90deg, transparent, rgba(214,199,184,.1), transparent); transition:left .6s ease; }
  .tariff-option:hover::before { left:100%; }
  .tariff-option:hover { border-color:#d6c7b8; transform:translateY(-4px); box-shadow:0 12px 30px rgba(214,199,184,.2); }
  .tariff-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
  .tariff-name { font-size:1.2rem; font-weight:600; color:#f0eadf; }
  .tariff-price { background: linear-gradient(135deg, #d6c7b8 0%, #f0eadf 100%); color:#121212; padding:8px 16px; border-radius:20px; font-weight:700; font-size:1rem; box-shadow:0 4px 15px rgba(214,199,184,.3); }
  .tariff-description { color:#a6a8ad; font-size:.9rem; line-height:1.4; }
  .payment-methods { display:grid; gap:16px; margin-top:20px; }
  .payment-method { background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%); border:2px solid #444; border-radius:16px; padding:20px; cursor:pointer; transition:all .3s ease; display:flex; align-items:center; gap:16px; }
  .payment-method:hover { border-color:#d6c7b8; transform:translateY(-2px); box-shadow:0 8px 25px rgba(214,199,184,.2); }
  .payment-icon { width:40px; height:40px; background: linear-gradient(135deg, #d6c7b8 0%, #f0eadf 100%); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.2rem; color:#121212; flex-shrink:0; }
  .payment-info { flex-grow:1; }
  .payment-name { font-size:1.1rem; font-weight:600; color:#f0eadf; margin-bottom:4px; }
  .payment-description { color:#a6a8ad; font-size:.9rem; }
  .form-group { margin-bottom:20px; }
  .form-label { display:block; font-size:1rem; font-weight:600; color:#f0eadf; margin-bottom:8px; }
  .form-input { width:100%; padding:16px; background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%); border:2px solid #444; border-radius:12px; color:#f0eadf; font-size:1rem; transition:all .3s ease; outline:none; }
  .form-input:focus { border-color:#d6c7b8; box-shadow:0 0 0 3px rgba(214,199,184,.1); }
  .form-input::placeholder { color:#a6a8ad; }
  .payment-method-display { display:flex; align-items:center; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); border:2px solid #3498db; border-radius:12px; padding:16px; margin:8px 0; position:relative; overflow:hidden; transition:all .3s ease; animation: paymentGlow 2s ease-in-out infinite alternate; }
  .payment-title { font-weight:600; color:#ecf0f1; font-size:16px; margin-bottom:4px; }
  .payment-subtitle { color:#bdc3c7; font-size:14px; font-style:italic; }
  @keyframes paymentGlow { 0%{ box-shadow:0 0 5px rgba(52,152,219,.3);} 100%{ box-shadow:0 0 20px rgba(52,152,219,.6);} }
  .button-group { display:grid; gap:12px; margin-top:24px; }
  .btn { padding:16px 24px; border:none; border-radius:12px; font-size:1rem; font-weight:600; cursor:pointer; transition:all .3s ease; text-align:center; display:flex; align-items:center; justify-content:center; gap:8px; }
  .btn-primary { background: linear-gradient(135deg, #d6c7b8 0%, #f0eadf 100%); color:#121212; box-shadow:0 4px 15px rgba(214,199,184,.3); }
  .btn-secondary { background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%); color:#f0eadf; border:2px solid #444; }
  .progress-bar { display:flex; justify-content:center; gap:8px; margin-bottom:24px; }
  .progress-step { width:12px; height:12px; border-radius:50%; background:#444; transition:all .3s ease; }
  .progress-step.active { background:#d6c7b8; transform:scale(1.2); }
  .progress-step.completed { background:#4CAF50; }
  @media (max-width:480px){ .content-block{padding:20px;} .tariff-option{padding:16px;} .payment-method{padding:16px;} .btn{padding:14px 20px;} }
  .step-container::-webkit-scrollbar { width:6px; }
  .step-container::-webkit-scrollbar-track { background:#1f1f1f; }
  .step-container::-webkit-scrollbar-thumb { background:#d6c7b8; border-radius:3px; }
  .error { color:#ff7b7b; font-size:.95rem; }
  .summary-item { display:flex; justify-content:space-between; border-bottom:1px dashed #333; padding:8px 0; }
  .summary-label { color:#a6a8ad; }
  .summary-value { color:#f0eadf; font-weight:600; }
</style>
</head>
<body>
<header>
  <h1>üí≥ –û–ø–ª–∞—Ç–∞ –¥–æ—Å—Ç—É–ø–∞
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
      <line x1="1" y1="10" x2="23" y2="10"/>
    </svg>
  </h1>
</header>

<main>
  <div class="step-container">
    <div class="step active" id="step1">
      <div class="progress-bar"><div class="progress-step active"></div><div class="progress-step"></div><div class="progress-step"></div><div class="progress-step"></div></div>
      <div class="content-block">
        <div class="content-text">–¢—ã —Å–¥–µ–ª–∞–ª –≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä.</div>
        <div class="content-text">–í—ã–±–µ—Ä–∏ —Ç–∞—Ä–∏—Ñ –ø–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –§–æ—Ä–º—É–ª—É:</div>
      </div>
      <div class="tariff-grid">
        <div class="tariff-option" data-tariff="1_month" data-price="50">
          <div class="tariff-header"><div class="tariff-name">1 –º–µ—Å—è—Ü</div><div class="tariff-price">50 ‚ÇΩ</div></div>
          <div class="tariff-description">–ë–∞–∑–æ–≤—ã–π –¥–æ—Å—Ç—É–ø –∫ –∑–∞–∫—Ä—ã—Ç–æ–º—É –∫–∞–Ω–∞–ª—É</div>
        </div>
      </div>
      <div class="content-block">
        <div class="content-text"><em>*—Ü–µ–Ω–∞ –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö/–µ–≤—Ä–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ –Ω—ã–Ω–µ—à–Ω–µ–º—É –∫—É—Ä—Å—É</em><br><em>*–æ–ø–ª–∞—á–∏–≤–∞–π –ª—é–±–æ–π –∫–∞—Ä—Ç–æ–π –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö/–µ–≤—Ä–æ/—Ä—É–±–ª—è—Ö, –±–æ—Ç —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Å–∞–º</em></div>
      </div>
    </div>

    <div class="step" id="step2">
      <div class="progress-bar"><div class="progress-step completed"></div><div class="progress-step active"></div><div class="progress-step"></div><div class="progress-step"></div></div>
      <div class="tariff-title-block"><div class="tariff-badge">–í–´–ë–†–ê–ù</div><div class="tariff-title-text" id="selectedTariffTitle">–ó–ê–ö–†–´–¢–´–ô –ö–ê–ù–ê–õ ¬´–§–û–†–ú–£–õ–ê¬ª –Ω–∞ 1 –º–µ—Å—è—Ü</div></div>
      <div class="content-block">
        <div class="content-text"><em>*–µ—Å–ª–∏ –≤—ã –∏–∑ –£–∫—Ä–∞–∏–Ω—ã, –≤–∫–ª—é—á–∏—Ç–µ VPN</em><br><em>*–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∫–∞—Ä—Ç–æ–π ‚Äî –æ—Ñ–æ—Ä–º–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 –¥–Ω–µ–π</em><br><em>*–¥–∞–ª–µ–µ ‚Äî –≤—ã —Å–º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–¥–ø–∏—Å–∫–æ–π –≤ –ú–µ–Ω—é</em></div>
        <div class="content-text">–¢–µ–ø–µ—Ä—å —Ç–µ–±–µ –æ—Å—Ç–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (–±–∞–Ω–∫):</div>
      </div>
      <div class="payment-methods">
        <div class="payment-method" data-method="card" data-bank="russian">
          <div class="payment-icon">üá∑üá∫</div><div class="payment-info"><div class="payment-name">–ë–∞–Ω–∫ –†–§ (RUB)</div><div class="payment-description">–õ—é–±–∞—è –±–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –†–§</div></div>
        </div>
        <div class="payment-method" data-method="card" data-bank="international">
          <div class="payment-icon">üåç</div><div class="payment-info"><div class="payment-name">–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π –±–∞–Ω–∫ (EUR)</div><div class="payment-description">–õ—é–±–∞—è –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞</div></div>
        </div>
      </div>
      <div class="button-group"><button class="btn btn-secondary" onclick="goToStep(1)">–ù–∞–∑–∞–¥</button></div>
    </div>

    <div class="step" id="step3">
      <div class="progress-bar"><div class="progress-step completed"></div><div class="progress-step completed"></div><div class="progress-step active"></div><div class="progress-step"></div></div>
      <div class="tariff-title-block"><div class="tariff-badge">–¢–û–í–ê–†</div><div class="tariff-title-text" id="productTitle">–ö–∞–Ω–∞–ª –§–û–†–ú–£–õ–ê / 1 –º–µ—Å.</div></div>
      <div class="content-block">
        <div class="content-text"><strong>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</strong><br><span id="productNameText">–ö–∞–Ω–∞–ª –§–û–†–ú–£–õ–ê / 1 –º–µ—Å.</span></div>
        <div class="form-group">
          <label class="form-label">–ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã</label>
          <div class="payment-method-display"><div class="payment-icon">üí≥</div><div class="payment-info"><div class="payment-title" id="bankTitle">–ë–∞–Ω–∫ –†–§</div><div class="payment-subtitle" id="bankSubtitle">–õ—é–±–∞—è –±–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</div></div></div>
        </div>
        <div class="form-group">
          <label class="form-label">–í–∞—à E-mail: <span style="color:#ff6b6b;">*</span></label>
          <input type="email" class="form-input" id="userEmail" placeholder="example@email.com" required>
          <div id="emailError" class="error" style="display:none;">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email</div>
        </div>
        <div class="content-text"><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å</strong><br><span id="finalPrice">50 RUB</span></div>
      </div>
      <div class="button-group"><button class="btn btn-primary" id="toConfirmBtn">–î–∞–ª–µ–µ</button><button class="btn btn-secondary" onclick="goToStep(2)">–ù–∞–∑–∞–¥</button></div>
    </div>

    <div class="step" id="step4">
      <div class="progress-bar"><div class="progress-step completed"></div><div class="progress-step completed"></div><div class="progress-step completed"></div><div class="progress-step active"></div></div>
      <div class="content-block" id="summaryBlock">
        <div class="content-text">–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–µ—Ä–Ω—ã:</div>
        <div class="summary-item"><span class="summary-label">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</span><span class="summary-value" id="confirmProductName">–ö–∞–Ω–∞–ª –§–û–†–ú–£–õ–ê / 1 –º–µ—Å.</span></div>
        <div class="summary-item"><span class="summary-label">–ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã</span><span class="summary-value" id="confirmPaymentMethod">–ë–∞–Ω–∫ –†–§</span></div>
        <div class="summary-item"><span class="summary-label">–í–∞—à E-mail</span><span class="summary-value" id="confirmEmail">example@email.com</span></div>
        <div class="summary-item"><span class="summary-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</span><span class="summary-value" id="confirmPrice">50 RUB</span></div>
        <div id="apiError" class="error" style="margin-top:8px;"></div>
      </div>
      <div class="button-group" id="payBtnGroup"><button class="btn btn-primary" id="payBtn">–û–ø–ª–∞—Ç–∏—Ç—å</button><button class="btn btn-secondary" onclick="goToStep(3)">–ù–∞–∑–∞–¥</button></div>
    </div>
  </div>
</main>

<script>
const tg = window.Telegram ? window.Telegram.WebApp : null;
if (tg) { tg.ready(); tg.expand(); }

const state = { currentStep:1, selectedTariff:null, selectedPaymentMethod:'card', selectedBank:null, userEmail:'',
  prices:{'1_month':50}, tariffNames:{'1_month':'1 –º–µ—Å—è—Ü'} };

document.addEventListener('DOMContentLoaded', initUI);
function initUI(){
  document.querySelectorAll('.tariff-option').forEach(opt=>{
    opt.addEventListener('click', ()=>{
      state.selectedTariff = opt.dataset.tariff;
      const price = Number(opt.dataset.price||0);
      document.querySelectorAll('.tariff-option').forEach(o=>o.style.borderColor='#444');
      opt.style.borderColor='#d6c7b8';
      const tName = state.tariffNames[state.selectedTariff] || '';
      document.getElementById('selectedTariffTitle').textContent = `–ó–ê–ö–†–´–¢–´–ô –ö–ê–ù–ê–õ ¬´–§–û–†–ú–£–õ–ê¬ª –Ω–∞ ${tName}`;
      document.getElementById('productTitle').textContent = `–ö–∞–Ω–∞–ª –§–û–†–ú–£–õ–ê / ${tName}`;
      document.getElementById('productNameText').textContent = `–ö–∞–Ω–∞–ª –§–û–†–ú–£–õ–ê / ${tName}`;
      document.getElementById('finalPrice').textContent = `${price} RUB`;
      document.getElementById('confirmProductName').textContent = `–ö–∞–Ω–∞–ª –§–û–†–ú–£–õ–ê / ${tName}`;
      document.getElementById('confirmPrice').textContent = `${price} RUB`;
      goToStep(2);
    });
  });
  document.querySelectorAll('.payment-method').forEach(m=>{
    m.addEventListener('click', ()=>{
      const bank = m.dataset.bank;
      state.selectedPaymentMethod='card'; state.selectedBank=bank;
      document.querySelectorAll('.payment-method').forEach(x=>x.style.borderColor='#444');
      m.style.borderColor='#d6c7b8';
      const isRu = bank==='russian';
      document.getElementById('bankTitle').textContent = isRu ? '–ë–∞–Ω–∫ –†–§' : '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π –±–∞–Ω–∫';
      document.getElementById('bankSubtitle').textContent = isRu ? '–õ—é–±–∞—è –±–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞' : '–û–ø–ª–∞—Ç–∞ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ–π';
      document.getElementById('confirmPaymentMethod').textContent = isRu ? '–ë–∞–Ω–∫ –†–§' : '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π –±–∞–Ω–∫';
      goToStep(3);
    });
  });
  const emailEl = document.getElementById('userEmail');
  const emailError = document.getElementById('emailError');
  emailEl.addEventListener('input', ()=>{
    state.userEmail = emailEl.value.trim();
    document.getElementById('confirmEmail').textContent = state.userEmail || '–ù–µ —É–∫–∞–∑–∞–Ω';
    emailError.style.display='none';
  });
  document.getElementById('toConfirmBtn').addEventListener('click', ()=>{
    if(!validateEmail(state.userEmail)){ emailError.style.display='block'; return; }
    goToStep(4);
  });
  document.getElementById('payBtn').addEventListener('click', createAndOpenInvoice);
}
function validateEmail(email){ return !!email && email.includes('@') && email.indexOf('.') > email.indexOf('@'); }
function goToStep(step){ document.querySelectorAll('.step').forEach(s=>s.classList.remove('active')); document.getElementById(`step${step}`).classList.add('active'); updateProgress(step); state.currentStep=step; }
function updateProgress(step){ const dots=document.querySelectorAll('.progress-step'); dots.forEach((d,i)=>{d.classList.remove('active','completed'); if(i+1<step) d.classList.add('completed'); else if(i+1===step) d.classList.add('active');}); }

async function createAndOpenInvoice(){
  const apiBase = "https://formulaprivate-production.up.railway.app";
  const btn = document.getElementById('payBtn');
  const apiError = document.getElementById('apiError'); apiError.textContent='';

  if(!state.selectedPaymentMethod) state.selectedPaymentMethod='card';
  if(!state.selectedBank) state.selectedBank='russian';
  if(!state.selectedTariff){ alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ'); goToStep(1); return; }
  if(!validateEmail(state.userEmail)){ alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email'); goToStep(3); return; }

  const tariffCode = 'basic';
  const telegram_id = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) ? tg.initDataUnsafe.user.id : null;
  const username = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.username) ? tg.initDataUnsafe.user.username : null;
  const init_data = tg ? tg.initData : null;

  const payload = { email: state.userEmail, tariff: tariffCode, bank: state.selectedBank, telegram_id, username, init_data };

  try{
    btn.disabled = true; btn.textContent = "–°–æ–∑–¥–∞–Ω–∏–µ —Å—á—ë—Ç–∞...";
    const r = await fetch(apiBase + "/api/pay/create", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
    const resp = await r.json();
    if(!resp.ok) throw new Error(resp.error || "–û—à–∏–±–∫–∞ API");
    if(!resp.payment_url) throw new Error("–ù–µ –ø–æ–ª—É—á–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É");
    window.location.href = resp.payment_url;
  }catch(e){
    console.error(e); apiError.textContent = "‚ùå " + e.message; btn.disabled=false; btn.textContent="–û–ø–ª–∞—Ç–∏—Ç—å";
  }
}
</script>
</body>
</html>