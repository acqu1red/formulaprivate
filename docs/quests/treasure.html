<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ü–æ–∏—Å–∫ —Å–æ–∫—Ä–æ–≤–∏—â ‚Äî –ö–≤–µ—Å—Ç‚Äë–•–∞–±</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sora:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../quests.css" />
  <style>
    .treasure-quest {
      position: relative;
      min-height: 100vh;
      background: linear-gradient(135deg, #0B1020 0%, #1A2332 100%);
      overflow: hidden;
    }
    
    .treasure-map {
      position: relative;
      height: 350px;
      border: 3px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      overflow: hidden;
      cursor: crosshair;
      transition: all 0.3s ease;
      margin: 20px 0;
    }
    
    .treasure-map:hover {
      border-color: var(--glow1);
      box-shadow: 0 0 40px rgba(102, 247, 213, 0.3);
    }
    
    .map-background {
      position: absolute;
      inset: 0;
      background: 
        radial-gradient(120% 100% at 60% 30%, rgba(255,255,255,.1), rgba(255,255,255,.02)),
        linear-gradient(45deg, #2a1810 0%, #3d2817 50%, #2a1810 100%);
      filter: sepia(0.4) contrast(1.3) brightness(0.8);
    }
    
    .map-grid {
      position: absolute;
      inset: 0;
      background-image: 
        linear-gradient(rgba(255,255,255,.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.1) 1px, transparent 1px);
      background-size: 40px 40px;
      opacity: 0.3;
    }
    
    .treasure-hint {
      position: absolute;
      top: 15px;
      left: 15px;
      right: 15px;
      background: rgba(0,0,0,0.8);
      color: var(--text);
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      backdrop-filter: blur(12px);
      border: 1px solid var(--border);
      z-index: 10;
    }
    
    .flash-effect {
      position: absolute;
      width: 80px;
      height: 80px;
      background: radial-gradient(circle, rgba(255, 226, 122, 0.9) 0%, rgba(255, 226, 122, 0.4) 50%, transparent 100%);
      border-radius: 50%;
      opacity: 0;
      transform: scale(0);
      transition: all 0.4s ease;
      pointer-events: none;
      z-index: 5;
    }
    
    .flash-effect.active {
      opacity: 1;
      transform: scale(1);
    }
    
    .treasure-spot {
      position: absolute;
      width: 20px;
      height: 20px;
      background: radial-gradient(circle, var(--glow1) 0%, transparent 70%);
      border-radius: 50%;
      opacity: 0;
      transform: scale(0);
      transition: all 0.3s ease;
      z-index: 3;
    }
    
    .treasure-spot.found {
      opacity: 1;
      transform: scale(1);
      animation: treasurePulse 2s infinite;
    }
    
    @keyframes treasurePulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.8; }
    }
    
    .clue-container {
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin: 20px 0;
    }
    
    .clue-text {
      font-size: 16px;
      color: var(--text);
      margin-bottom: 15px;
      line-height: 1.5;
    }
    
    .clue-options {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 15px;
    }
    
    .clue-option {
      background: var(--glass-strong);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .clue-option:hover {
      border-color: var(--glow1);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 247, 213, 0.1);
    }
    
    .clue-option.correct {
      border-color: var(--success);
      background: rgba(74, 222, 128, 0.1);
    }
    
    .clue-option.incorrect {
      border-color: var(--error);
      background: rgba(248, 113, 113, 0.1);
    }
    
    .option-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--glass);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }
    
    .option-content {
      flex: 1;
    }
    
    .option-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text);
    }
    
    .option-description {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.4;
    }
    
    .progress-container {
      margin: 20px 0;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: var(--glass);
      padding: 12px;
      border-radius: var(--radius-sm);
      text-align: center;
      border: 1px solid var(--border);
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--glow1);
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .treasure-found {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--glass-strong);
      border: 2px solid var(--glow1);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
      opacity: 0;
      pointer-events: none;
      transition: all 0.5s ease;
      z-index: 20;
      backdrop-filter: blur(20px);
    }
    
    .treasure-found.show {
      opacity: 1;
      pointer-events: all;
    }
    
    .treasure-icon {
      font-size: 48px;
      margin-bottom: 10px;
      animation: treasureBounce 1s infinite;
    }
    
    @keyframes treasureBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .quest-phase {
      display: none;
    }
    
    .quest-phase.active {
      display: block;
    }
    
    .phase-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 20px 0;
    }
    
    .phase-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.3s ease;
    }
    
    .phase-dot.active {
      background: var(--glow1);
      transform: scale(1.2);
    }
    
    .phase-dot.completed {
      background: var(--success);
    }
  </style>
</head>
<body>
  <div class="treasure-quest">
    <div class="app">
      <header class="glass topbar">
        <div class="brand">
          <button id="btnBack" class="btn ghost">‚Üê</button>
          <h1>–ü–æ–∏—Å–∫ —Å–æ–∫—Ä–æ–≤–∏—â</h1>
          <div class="badge">–§–∞–∑–∞ <span id="currentPhase">1</span>/3</div>
        </div>
        <div class="actions">
          <button id="btnHelp" class="btn ghost">‚ùì</button>
        </div>
      </header>

      <main class="content">
        <div class="phase-indicator">
          <div class="phase-dot active" data-phase="1"></div>
          <div class="phase-dot" data-phase="2"></div>
          <div class="phase-dot" data-phase="3"></div>
        </div>

        <!-- –§–∞–∑–∞ 1: –ê–Ω–∞–ª–∏–∑ –∫–∞—Ä—Ç—ã -->
        <div id="phase1" class="quest-phase active">
          <div class="clue-container">
            <h3>üó∫Ô∏è –ê–Ω–∞–ª–∏–∑ –¥—Ä–µ–≤–Ω–µ–π –∫–∞—Ä—Ç—ã</h3>
            <div class="clue-text">
              –¢—ã –Ω–∞—à–µ–ª –¥—Ä–µ–≤–Ω—é—é –∫–∞—Ä—Ç—É —Å–æ–∫—Ä–æ–≤–∏—â! –ù–∞ –Ω–µ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω—ã –∑–∞–≥–∞–¥–æ—á–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã. 
              –ò–∑—É—á–∏ –∫–∞—Ä—Ç—É –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏ –≤—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é —Å–∏–º–≤–æ–ª–æ–≤.
            </div>
            <div class="clue-options" id="phase1Options">
              <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
          </div>
        </div>

        <!-- –§–∞–∑–∞ 2: –ü–æ–∏—Å–∫ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º -->
        <div id="phase2" class="quest-phase">
          <div class="clue-container">
            <h3>üéØ –ü–æ–∏—Å–∫ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º</h3>
            <div class="clue-text">
              –¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ —Ç–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–æ–∫—Ä–æ–≤–∏—â–∞. –ö–∞—Ä—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–µ—Ç–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç. 
              –í—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–æ–º–±–∏–Ω–∞—Ü–∏—é –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫.
            </div>
            <div class="clue-options" id="phase2Options">
              <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
          </div>
        </div>

        <!-- –§–∞–∑–∞ 3: –§–∏–Ω–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ -->
        <div id="phase3" class="quest-phase">
          <div class="clue-container">
            <h3>üíé –§–∏–Ω–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫</h3>
            <div class="clue-text">
              –ü–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–ø! –°–æ–∫—Ä–æ–≤–∏—â–µ —Å–ø—Ä—è—Ç–∞–Ω–æ –≥–¥–µ-—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ. 
              –°–ª–µ–¥–∏ –∑–∞ –≤—Å–ø—ã—à–∫–∞–º–∏ —Å–≤–µ—Ç–∞ –∏ –∫–ª–∏–∫–∞–π –≤ –Ω—É–∂–Ω—ã–µ –º–µ—Å—Ç–∞. –£ —Ç–µ–±—è –µ—Å—Ç—å 3 –ø–æ–ø—ã—Ç–∫–∏!
            </div>
          </div>

          <div class="treasure-map" id="treasureMap">
            <div class="map-background"></div>
            <div class="map-grid"></div>
            <div class="treasure-hint" id="treasureHint">
              –ö–ª–∏–∫–∞–π –Ω–∞ –≤—Å–ø—ã—à–∫–∏ —Å–≤–µ—Ç–∞, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å–æ–∫—Ä–æ–≤–∏—â–µ!
            </div>
            <div class="flash-effect" id="flashEffect"></div>
            <div class="treasure-spot" id="treasureSpot"></div>
          </div>

          <div class="stats">
            <div class="stat-card">
              <div class="stat-value" id="triesValue">0</div>
              <div class="stat-label">–ü–æ–ø—ã—Ç–∫–∏</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="hitsValue">0</div>
              <div class="stat-label">–ü–æ–ø–∞–¥–∞–Ω–∏—è</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="scoreValue">0</div>
              <div class="stat-label">–û—á–∫–∏</div>
            </div>
          </div>

          <div class="questActions">
            <button id="startBtn" class="btn primary">–ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫</button>
          </div>
        </div>
        
        <div class="quest-footer fixed-bottom">
          <div class="quest-controls">
            <button id="nextBtn" class="btn primary" style="display: none;">–°–ª–µ–¥—É—é—â–∏–π —Ç–µ—Å—Ç</button>
            <button id="resetBtn" class="btn ghost">–°–±—Ä–æ—Å–∏—Ç—å</button>
          </div>
        </div>
        </div>

        <div class="treasure-found" id="treasureFound">
          <div class="treasure-icon">üíé</div>
          <h3>–ö–≤–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!</h3>
          <p>–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –¢—ã —É—Å–ø–µ—à–Ω–æ –Ω–∞—à–µ–ª –≤—Å–µ —Å–æ–∫—Ä–æ–≤–∏—â–∞.</p>
          <div style="background: var(--glass); border-radius: var(--radius-sm); padding: 16px; margin: 16px 0;">
            <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <div style="text-align: center;">
                <div style="font-size: 20px; font-weight: 700; color: var(--glow1);">+1</div>
                <div style="font-size: 12px; color: var(--text-muted);">Mulacoin</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 20px; font-weight: 700; color: var(--glow2);">+150</div>
                <div style="font-size: 12px; color: var(--text-muted);">–û–ø—ã—Ç–∞</div>
              </div>
            </div>
          </div>
          <p style="font-size: 14px; color: var(--text-muted); margin-top: 16px;">
            –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é –ø–æ –∫–Ω–æ–ø–∫–µ "–ò—Å—Ç–æ—Ä–∏—è"
          </p>
          <div class="questActions">
            <button id="completeBtn" class="btn primary">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
          </div>
        </div>
      </main>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–≤–µ—Å—Ç–∞
    const QUEST_CONFIG = {
      maxTries: 3,
      flashDuration: 800,
      flashInterval: 600,
      hitRadius: 60,
      rewards: { fragments: 2, experience: 50 }
    };

    // –î–∞–Ω–Ω—ã–µ –∫–≤–µ—Å—Ç–∞
    const QUEST_DATA = {
      phase1: {
        question: "–ß—Ç–æ –æ–∑–Ω–∞—á–∞—é—Ç —Å–∏–º–≤–æ–ª—ã –Ω–∞ –∫–∞—Ä—Ç–µ?",
        options: [
          {
            icon: "‚≠ê",
            title: "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∑–≤–µ–∑–¥",
            description: "–ê—Å—Ç—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏",
            correct: false
          },
          {
            icon: "üï≥Ô∏è",
            title: "–ü–æ–¥–∑–µ–º–Ω—ã–µ —Ç—É–Ω–Ω–µ–ª–∏",
            description: "–°–µ—Ç—å –ø–æ–¥–∑–µ–º–Ω—ã—Ö –ø—Ä–æ—Ö–æ–¥–æ–≤ –∏ –ø–µ—â–µ—Ä",
            correct: true
          },
          {
            icon: "üåä",
            title: "–ú–æ—Ä—Å–∫–∏–µ —Ç–µ—á–µ–Ω–∏—è",
            description: "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ—Ä—Å–∫–∏—Ö –ø–æ—Ç–æ–∫–æ–≤",
            correct: false
          },
          {
            icon: "üí®",
            title: "–í–æ–∑–¥—É—à–Ω—ã–µ –ø–æ—Ç–æ–∫–∏",
            description: "–í–µ—Ç—Ä–æ–≤—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –≤–æ–∑–¥—É—à–Ω—ã–µ –ø—É—Ç–∏",
            correct: false
          }
        ]
      },
      phase2: {
        question: "–í—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:",
        options: [
          {
            icon: "üìç",
            title: "A3-B7",
            description: "–°–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥–Ω—ã–π —Å–µ–∫—Ç–æ—Ä –∫–∞—Ä—Ç—ã",
            correct: false
          },
          {
            icon: "üìç",
            title: "C5-D8",
            description: "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω",
            correct: false
          },
          {
            icon: "üìç",
            title: "E2-F6",
            description: "–í–æ—Å—Ç–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —Å –ø–µ—â–µ—Ä–∞–º–∏",
            correct: true
          },
          {
            icon: "üìç",
            title: "G1-H4",
            description: "–Æ–∂–Ω–∞—è —á–∞—Å—Ç—å —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏",
            correct: false
          }
        ]
      },
      phase3: {
        treasurePositions: [
          { x: 150, y: 120 },
          { x: 280, y: 200 },
          { x: 180, y: 280 }
        ]
      }
    };

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    let gameState = {
      currentPhase: 1,
      tries: 0,
      hits: 0,
      score: 0,
      isRunning: false,
      currentFlash: null,
      foundTreasures: []
    };

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const map = document.getElementById('treasureMap');
    const flashEffect = document.getElementById('flashEffect');
    const treasureSpot = document.getElementById('treasureSpot');
    const treasureFound = document.getElementById('treasureFound');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const triesValue = document.getElementById('triesValue');
    const hitsValue = document.getElementById('hitsValue');
    const scoreValue = document.getElementById('scoreValue');
    const btnBack = document.getElementById('btnBack');
    const btnHelp = document.getElementById('btnHelp');
    const completeBtn = document.getElementById('completeBtn');

    // –£—Ç–∏–ª–∏—Ç—ã
    const toast = (msg, type = 'info') => {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = `toast ${type}`;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function init() {
      updateStats();
      setupEventListeners();
      loadPhase(1);
    }

    function setupEventListeners() {
      startBtn.addEventListener('click', startGame);
      resetBtn.addEventListener('click', resetGame);
      btnBack.addEventListener('click', () => {
        if (window.history.length > 1) {
          window.history.back();
        } else {
          window.location.href = '../quests.html';
        }
      });
      btnHelp.addEventListener('click', showHelp);
      completeBtn.addEventListener('click', completeQuest);
      map.addEventListener('click', handleMapClick);
    }

    function loadPhase(phase) {
      gameState.currentPhase = phase;
      
      // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ñ–∞–∑—ã
      document.querySelectorAll('.quest-phase').forEach(p => p.classList.remove('active'));
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Ñ–∞–∑—É
      document.getElementById(`phase${phase}`).classList.add('active');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ñ–∞–∑
      updatePhaseIndicator(phase);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —Ñ–∞–∑—ã
      if (phase === 1) {
        loadPhase1();
      } else if (phase === 2) {
        loadPhase2();
      } else if (phase === 3) {
        loadPhase3();
      }
    }

    function updatePhaseIndicator(phase) {
      document.querySelectorAll('.phase-dot').forEach((dot, index) => {
        dot.classList.remove('active', 'completed');
        if (index + 1 < phase) {
          dot.classList.add('completed');
        } else if (index + 1 === phase) {
          dot.classList.add('active');
        }
      });
      
      document.getElementById('currentPhase').textContent = phase;
    }

    function loadPhase1() {
      const container = document.getElementById('phase1Options');
      container.innerHTML = '';
      
      QUEST_DATA.phase1.options.forEach((option, index) => {
        const optionEl = createOptionElement(option, index, handlePhase1Answer);
        container.appendChild(optionEl);
      });
    }

    function loadPhase2() {
      const container = document.getElementById('phase2Options');
      container.innerHTML = '';
      
      QUEST_DATA.phase2.options.forEach((option, index) => {
        const optionEl = createOptionElement(option, index, handlePhase2Answer);
        container.appendChild(optionEl);
      });
    }

    function loadPhase3() {
      // –§–∞–∑–∞ 3 —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –≤ HTML
    }

    function createOptionElement(option, index, handler) {
      const optionEl = document.createElement('div');
      optionEl.className = 'clue-option';
      optionEl.innerHTML = `
        <div class="option-icon">${option.icon}</div>
        <div class="option-content">
          <div class="option-title">${option.title}</div>
          <div class="option-description">${option.description}</div>
        </div>
      `;
      optionEl.addEventListener('click', () => handler(index));
      return optionEl;
    }

    function handlePhase1Answer(index) {
      const options = document.querySelectorAll('#phase1Options .clue-option');
      const correct = QUEST_DATA.phase1.options[index].correct;
      
      options.forEach((opt, i) => {
        if (i === index) {
          opt.classList.add(correct ? 'correct' : 'incorrect');
        }
        opt.style.pointerEvents = 'none';
      });
      
      if (correct) {
        toast('–ü—Ä–∞–≤–∏–ª—å–Ω–æ! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π —Ñ–∞–∑–µ.', 'success');
        setTimeout(() => loadPhase(2), 1500);
      } else {
        toast('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.', 'error');
        setTimeout(() => {
          options.forEach(opt => {
            opt.classList.remove('correct', 'incorrect');
            opt.style.pointerEvents = 'auto';
          });
        }, 2000);
      }
    }

    function handlePhase2Answer(index) {
      const options = document.querySelectorAll('#phase2Options .clue-option');
      const correct = QUEST_DATA.phase2.options[index].correct;
      
      options.forEach((opt, i) => {
        if (i === index) {
          opt.classList.add(correct ? 'correct' : 'incorrect');
        }
        opt.style.pointerEvents = 'none';
      });
      
      if (correct) {
        toast('–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫!', 'success');
        setTimeout(() => loadPhase(3), 1500);
      } else {
        toast('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.', 'error');
        setTimeout(() => {
          options.forEach(opt => {
            opt.classList.remove('correct', 'incorrect');
            opt.style.pointerEvents = 'auto';
          });
        }, 2000);
      }
    }

    function startGame() {
      if (gameState.isRunning) return;
      
      gameState.isRunning = true;
      gameState.tries = 0;
      gameState.hits = 0;
      gameState.score = 0;
      gameState.foundTreasures = [];
      
      updateStats();
      startBtn.textContent = '–ü–æ–∏—Å–∫ –∏–¥–µ—Ç...';
      startBtn.disabled = true;
      
      // –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–ø—ã—à–∫–∏
      showRandomFlash();
    }

    function showRandomFlash() {
      if (!gameState.isRunning) return;
      
      const rect = map.getBoundingClientRect();
      const positions = QUEST_DATA.phase3.treasurePositions;
      const randomPos = positions[Math.floor(Math.random() * positions.length)];
      
      flashEffect.style.left = `${randomPos.x}px`;
      flashEffect.style.top = `${randomPos.y}px`;
      flashEffect.classList.add('active');
      
      gameState.currentFlash = randomPos;
      
      setTimeout(() => {
        flashEffect.classList.remove('active');
        setTimeout(() => {
          if (gameState.isRunning) {
            showRandomFlash();
          }
        }, QUEST_CONFIG.flashInterval);
      }, QUEST_CONFIG.flashDuration);
    }

    function handleMapClick(e) {
      if (!gameState.isRunning || !gameState.currentFlash) return;
      
      const rect = map.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const clickY = e.clientY - rect.top;
      
      const distance = Math.sqrt(
        Math.pow(clickX - gameState.currentFlash.x, 2) + 
        Math.pow(clickY - gameState.currentFlash.y, 2)
      );
      
      gameState.tries++;
      
      if (distance <= QUEST_CONFIG.hitRadius) {
        // –ü–æ–ø–∞–¥–∞–Ω–∏–µ!
        gameState.hits++;
        gameState.score += 100;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω–æ–µ —Å–æ–∫—Ä–æ–≤–∏—â–µ
        treasureSpot.style.left = `${gameState.currentFlash.x - 10}px`;
        treasureSpot.style.top = `${gameState.currentFlash.y - 10}px`;
        treasureSpot.classList.add('found');
        
        gameState.foundTreasures.push(gameState.currentFlash);
        
        toast('–°–æ–∫—Ä–æ–≤–∏—â–µ –Ω–∞–π–¥–µ–Ω–æ! +100 –æ—á–∫–æ–≤', 'success');
        
        if (gameState.foundTreasures.length >= 3) {
          // –í—Å–µ —Å–æ–∫—Ä–æ–≤–∏—â–∞ –Ω–∞–π–¥–µ–Ω—ã!
          endGame(true);
        }
      } else {
        gameState.score = Math.max(0, gameState.score - 20);
        toast('–ü—Ä–æ–º–∞—Ö! -20 –æ—á–∫–æ–≤', 'error');
      }
      
      updateStats();
      
      if (gameState.tries >= QUEST_CONFIG.maxTries) {
        endGame(false);
      }
    }

    function endGame(success) {
      gameState.isRunning = false;
      startBtn.textContent = '–ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫';
      startBtn.disabled = false;
      
      if (success) {
        treasureFound.classList.add('show');
        toast('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—Å–µ —Å–æ–∫—Ä–æ–≤–∏—â–∞ –Ω–∞–π–¥–µ–Ω—ã!', 'success');
      } else {
        toast('–ü–æ–ø—ã—Ç–∫–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑!', 'error');
      }
    }

    function resetGame() {
      gameState.isRunning = false;
      gameState.tries = 0;
      gameState.hits = 0;
      gameState.score = 0;
      gameState.foundTreasures = [];
      
      flashEffect.classList.remove('active');
      treasureSpot.classList.remove('found');
      treasureFound.classList.remove('show');
      
      updateStats();
      startBtn.textContent = '–ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫';
      startBtn.disabled = false;
    }

    function updateStats() {
      triesValue.textContent = gameState.tries;
      hitsValue.textContent = gameState.hits;
      scoreValue.textContent = gameState.score;
    }

    function showHelp() {
      toast('–ö–ª–∏–∫–Ω–∏ –Ω–∞ –≤—Å–ø—ã—à–∫–∏ —Å–≤–µ—Ç–∞, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å–æ–∫—Ä–æ–≤–∏—â–∞!', 'info');
    }

    function completeQuest() {
      toast('–ö–≤–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ —Ö–∞–±...', 'success');
      setTimeout(() => {
        if (window.history.length > 1) {
          window.history.back();
        } else {
          window.location.href = '../quests.html';
        }
      }, 1500);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    document.getElementById('nextBtn').addEventListener('click', () => {
      if (gameState.currentPhase === 1) {
        loadPhase2();
      }
    });
    
    document.getElementById('resetBtn').addEventListener('click', () => {
      if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–≤–µ—Å—Ç–∞?')) {
        init();
      }
    });
    
    // –ó–∞–ø—É—Å–∫
    init();
  </script>
</body>
</html>
