<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ü–æ–∏—Å–∫ —Å–æ–∫—Ä–æ–≤–∏—â ‚Äî –ö–≤–µ—Å—Ç‚Äë–•–∞–±</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sora:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../quests.css" />
  <style>
    .treasure-map {
      position: relative;
      height: 400px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      overflow: hidden;
      cursor: crosshair;
      transition: all 0.3s ease;
    }
    
    .treasure-map:hover {
      border-color: var(--glow1);
      box-shadow: 0 0 30px rgba(102, 247, 213, 0.2);
    }
    
    .map-background {
      position: absolute;
      inset: 0;
      background: 
        radial-gradient(120% 100% at 60% 30%, rgba(255,255,255,.08), rgba(255,255,255,.02)),
        url('https://picsum.photos/seed/treasure/800/400') center/cover;
      filter: sepia(0.3) contrast(1.2);
    }
    
    .flash-effect {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at var(--flash-x, 50%) var(--flash-y, 50%), 
        rgba(255, 226, 122, 0.8) 0%, 
        rgba(255, 226, 122, 0.4) 20%, 
        transparent 60%);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    
    .flash-effect.active {
      opacity: 1;
    }
    
    .treasure-hint {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: var(--text);
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      backdrop-filter: blur(8px);
      border: 1px solid var(--border);
    }
    
    .progress-container {
      margin: 20px 0;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: var(--glass);
      padding: 12px;
      border-radius: var(--radius-sm);
      text-align: center;
      border: 1px solid var(--border);
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--glow1);
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .treasure-found {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, var(--success), #22C55E);
      color: white;
      padding: 20px 30px;
      border-radius: var(--radius);
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.8);
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 10;
    }
    
    .treasure-found.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
    
    .particles {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }
    
    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: var(--accent);
      border-radius: 50%;
      animation: sparkle 2s ease-out forwards;
    }
    
    @keyframes sparkle {
      0% {
        opacity: 1;
        transform: scale(0) rotate(0deg);
      }
      50% {
        opacity: 1;
        transform: scale(1) rotate(180deg);
      }
      100% {
        opacity: 0;
        transform: scale(0) rotate(360deg);
      }
    }
  </style>
</head>
<body>
  <div id="app" class="app">
    <header class="glass topbar">
      <div class="brand">
        <span class="logoGlow"></span>
        <h1>–ü–æ–∏—Å–∫ —Å–æ–∫—Ä–æ–≤–∏—â</h1>
        <div class="badge">–î–∏–∫–∏–π –∑–∞–ø–∞–¥</div>
      </div>
      <div class="actions">
        <button id="btnBack" class="btn ghost">‚Üê –ù–∞–∑–∞–¥</button>
      </div>
    </header>

    <div class="quest-container">
      <div class="quest-header">
        <h2>üó∫Ô∏è –ü–æ–∏—Å–∫ —Å–æ–∫—Ä–æ–≤–∏—â</h2>
        <div class="theme">–î–∏–∫–∏–π –∑–∞–ø–∞–¥ ‚Ä¢ –õ–µ–≥–∫–∏–π —É—Ä–æ–≤–µ–Ω—å</div>
      </div>

      <div class="quest-content">
        <div class="banner">
          <strong>–ó–∞–¥–∞—á–∞:</strong> –ò—Å—Å–ª–µ–¥—É–π –∑–∞–≥–∞–¥–æ—á–Ω—É—é –∫–∞—Ä—Ç—É –∏ —Å–ª–µ–¥—É–π –∑–∞ –≤—Å–ø—ã—à–∫–∞–º–∏ —Å–≤–µ—Ç–∞, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å–ø—Ä—è—Ç–∞–Ω–Ω—ã–µ —Å–æ–∫—Ä–æ–≤–∏—â–∞.
        </div>

        <div class="treasure-map" id="treasureMap">
          <div class="map-background"></div>
          <div class="flash-effect" id="flashEffect"></div>
          <div class="treasure-hint">
            üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: –¢—Ä–∏ –≤—Å–ø—ã—à–∫–∏ —É–∫–∞–∂—É—Ç –Ω–∞ —Ç–∞–π–Ω–∏–∫. –ù–∞–∂–º–∏ –Ω–∞ –∫–∞—Ä—Ç—É, –∫–æ–≥–¥–∞ –≤—Å–ø—ã—à–∫–∞ –∑–∞—Ç—É—Ö–∞–µ—Ç.
          </div>
          <div class="particles" id="particles"></div>
          <div class="treasure-found" id="treasureFound">
            üéâ –°–æ–∫—Ä–æ–≤–∏—â–µ –Ω–∞–π–¥–µ–Ω–æ!<br>
            <small>+2 —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞</small>
          </div>
        </div>

        <div class="progress-container">
          <div class="progress">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
          </div>
        </div>

        <div class="stats">
          <div class="stat-card">
            <div class="stat-value" id="triesValue">0</div>
            <div class="stat-label">–ü–æ–ø—ã—Ç–∫–∏</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="hitsValue">0</div>
            <div class="stat-label">–ü–æ–ø–∞–¥–∞–Ω–∏—è</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="scoreValue">0</div>
            <div class="stat-label">–û—á–∫–∏</div>
          </div>
        </div>

        <div class="questActions">
          <button id="startBtn" class="btn primary">–ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫</button>
          <button id="resetBtn" class="btn ghost">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
      </div>

      <div class="quest-footer">
        <div class="banner">
          <strong>–ù–∞–≥—Ä–∞–¥—ã:</strong> –§—Ä–∞–≥–º–µ–Ω—Ç—ã +2, –û–ø—ã—Ç +50
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const QUEST_CONFIG = {
      maxTries: 3,
      flashDuration: 900,
      flashInterval: 700,
      hitRadius: 50,
      rewards: { fragments: 2, experience: 50 }
    };

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    let gameState = {
      tries: 0,
      hits: 0,
      score: 0,
      isRunning: false,
      currentFlash: null
    };

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const map = document.getElementById('treasureMap');
    const flashEffect = document.getElementById('flashEffect');
    const particles = document.getElementById('particles');
    const treasureFound = document.getElementById('treasureFound');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const progressBar = document.getElementById('progressBar');
    const triesValue = document.getElementById('triesValue');
    const hitsValue = document.getElementById('hitsValue');
    const scoreValue = document.getElementById('scoreValue');
    const btnBack = document.getElementById('btnBack');

    // –£—Ç–∏–ª–∏—Ç—ã
    const toast = (msg, type = 'info') => {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = `toast ${type}`;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function init() {
      updateStats();
      setupEventListeners();
    }

    function setupEventListeners() {
      startBtn.addEventListener('click', startGame);
      resetBtn.addEventListener('click', resetGame);
      btnBack.addEventListener('click', () => {
        if (window.history.length > 1) {
          window.history.back();
        } else {
          window.location.href = '../quests.html';
        }
      });

      map.addEventListener('click', handleMapClick);
    }

    function startGame() {
      if (gameState.isRunning) return;
      
      gameState.isRunning = true;
      gameState.tries = 0;
      gameState.hits = 0;
      gameState.score = 0;
      
      updateStats();
      startBtn.disabled = true;
      startBtn.textContent = '–ü–æ–∏—Å–∫...';
      
      runFlashSequence();
    }

    function runFlashSequence() {
      if (gameState.tries >= QUEST_CONFIG.maxTries) {
        endGame();
        return;
      }

      gameState.tries++;
      updateStats();

      // –°–ª—É—á–∞–π–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –≤—Å–ø—ã—à–∫–∏
      const x = Math.random() * 80 + 10; // 10-90%
      const y = Math.random() * 80 + 10; // 10-90%
      
      gameState.currentFlash = { x, y };
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø—ã—à–∫—É
      flashEffect.style.setProperty('--flash-x', x + '%');
      flashEffect.style.setProperty('--flash-y', y + '%');
      flashEffect.classList.add('active');
      
      // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ –≤—Ä–µ–º—è
      setTimeout(() => {
        flashEffect.classList.remove('active');
        gameState.currentFlash = null;
        
        // –°–ª–µ–¥—É—é—â–∞—è –≤—Å–ø—ã—à–∫–∞
        if (gameState.tries < QUEST_CONFIG.maxTries) {
          setTimeout(runFlashSequence, QUEST_CONFIG.flashInterval);
        } else {
          setTimeout(endGame, 500);
        }
      }, QUEST_CONFIG.flashDuration);
    }

    function handleMapClick(e) {
      if (!gameState.currentFlash) return;
      
      const rect = map.getBoundingClientRect();
      const clickX = ((e.clientX - rect.left) / rect.width) * 100;
      const clickY = ((e.clientY - rect.top) / rect.height) * 100;
      
      const distance = Math.sqrt(
        Math.pow(clickX - gameState.currentFlash.x, 2) + 
        Math.pow(clickY - gameState.currentFlash.y, 2)
      );
      
      if (distance <= QUEST_CONFIG.hitRadius) {
        gameState.hits++;
        gameState.score += 10;
        toast('üéØ –ü–æ–ø–∞–¥–∞–Ω–∏–µ! +10 –æ—á–∫–æ–≤', 'success');
        createParticles(e.clientX - rect.left, e.clientY - rect.top);
      } else {
        toast('üí® –ü—Ä–æ–º–∞—Ö!', 'warning');
      }
      
      updateStats();
    }

    function createParticles(x, y) {
      for (let i = 0; i < 8; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = x + 'px';
        particle.style.top = y + 'px';
        particle.style.animationDelay = Math.random() * 0.5 + 's';
        particle.style.animationDuration = (1 + Math.random()) + 's';
        
        particles.appendChild(particle);
        
        setTimeout(() => {
          particle.remove();
        }, 2000);
      }
    }

    function endGame() {
      gameState.isRunning = false;
      startBtn.disabled = false;
      startBtn.textContent = '–ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫';
      
      const progress = (gameState.hits / QUEST_CONFIG.maxTries) * 100;
      progressBar.style.width = progress + '%';
      
      if (gameState.hits >= 2) {
        showTreasureFound();
        toast(`üéâ –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –ù–∞–π–¥–µ–Ω–æ ${gameState.hits}/3 —Å–æ–∫—Ä–æ–≤–∏—â!`, 'success');
      } else if (gameState.hits >= 1) {
        toast(`üëç –•–æ—Ä–æ—à–æ! –ù–∞–π–¥–µ–Ω–æ ${gameState.hits}/3 —Å–æ–∫—Ä–æ–≤–∏—â`, 'info');
      } else {
        toast('üòî –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑!', 'warning');
      }
    }

    function showTreasureFound() {
      treasureFound.classList.add('show');
      setTimeout(() => {
        treasureFound.classList.remove('show');
      }, 3000);
    }

    function resetGame() {
      gameState = {
        tries: 0,
        hits: 0,
        score: 0,
        isRunning: false,
        currentFlash: null
      };
      
      updateStats();
      progressBar.style.width = '0%';
      flashEffect.classList.remove('active');
      startBtn.disabled = false;
      startBtn.textContent = '–ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫';
    }

    function updateStats() {
      triesValue.textContent = gameState.tries;
      hitsValue.textContent = gameState.hits;
      scoreValue.textContent = gameState.score;
    }

    // –ó–∞–ø—É—Å–∫
    init();
  </script>
</body>
</html>
