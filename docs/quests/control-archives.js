/* ====== CONFIG ====== */
const SUPABASE_URL = window.SUPABASE_URL || "https://uhhsrtmmuwoxsdquimaa.supabase.co";
const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVoaHNydG1tdXdveHNkcXVpbWFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2OTMwMzcsImV4cCI6MjA3MDI2OTAzN30.5xxo6g-GEYh4ufTibaAtbgrifPIU_ilzGzolAdmAnm8";

/* ====== Global Variables ====== */
let tg = null;
let supabase = null;
let userData = {
  telegramId: null,
  mulacoin: 0,
  level: 1,
  experience: 0
};

let currentCategory = null;
let documentsAnalyzed = 0;
let totalDocuments = 20;
let analysisScore = 0;
let currentDocumentIndex = 0;

/* ====== Document Database ====== */
const DOCUMENT_CATEGORIES = {
  media: {
    name: "–ú–µ–¥–∏–∞ –ö–æ–Ω—Ç—Ä–æ–ª—å",
    icon: "üì∫",
    documents: [
      {
        title: "–û–ø–µ—Ä–∞—Ü–∏—è 'Mockingbird'",
        date: "1952-1975",
        content: `
–°–û–í–ï–†–®–ï–ù–ù–û –°–ï–ö–†–ï–¢–ù–û - –¶–†–£

–û–ü–ï–†–ê–¶–ò–Ø "MOCKINGBIRD"

–î–∞–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥—É—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤ –≤–ª–∏—è–Ω–∏—è –≤ –≤–µ–¥—É—â–∏–µ –º–µ–¥–∏–∞-–∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏ –°–®–ê –∏ –ó–∞–ø–∞–¥–Ω–æ–π –ï–≤—Ä–æ–ø—ã.

–¶–ï–õ–ò:
- –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –º–Ω–µ–Ω–∏—è –≤ –Ω—É–∂–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
- –ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π
- –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–∞—Ä—Ä–∞—Ç–∏–≤–æ–≤

–ú–ï–¢–û–î–´:
1. –í–µ—Ä–±–æ–≤–∫–∞ –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–≤ –∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤
2. –§–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–æ–¥—Å—Ç–∞–≤–Ω—ã–µ —Ñ–æ–Ω–¥—ã
3. –†–∞–∑–º–µ—â–µ–Ω–∏–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
4. –¶–µ–Ω–∑—É—Ä–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π

–†–ï–ó–£–õ–¨–¢–ê–¢–´:
–ù–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –Ω–∞—Ö–æ–¥—è—Ç—Å—è –±–æ–ª–µ–µ 400 –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–≤ –≤ 25 —Å—Ç—Ä–∞–Ω–∞—Ö. –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 87%.

–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
–†–∞—Å—à–∏—Ä–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –Ω–∞ —Ü–∏—Ñ—Ä–æ–≤—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏.
        `,
        connections: ["üì∫ –ö—Ä—É–ø–Ω—ã–µ –º–µ–¥–∏–∞-–∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏", "üèõÔ∏è –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞", "üí∞ –¢–µ–Ω–µ–≤—ã–µ —Ñ–æ–Ω–¥—ã"]
      },
      {
        title: "–ü—Ä–æ–µ–∫—Ç '–ú–∞—Å—Å–æ–≤–∞—è –ì–∏–ø–Ω–æ–∑–∞'",
        date: "1960-1980",
        content: `
–£–õ–¨–¢–†–ê –°–ï–ö–†–ï–¢–ù–û - TAVISTOCK INSTITUTE

–ü–†–û–ï–ö–¢ "–ú–ê–°–°–û–í–ê–Ø –ì–ò–ü–ù–û–ó–ê"

–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤ –º–∞—Å—Å–æ–≤–æ–≥–æ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ —Ç–µ–ª–µ–≤–∏–∑–∏–æ–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—á–∏ –∏ —Ä–∞–¥–∏–æ–≤–µ—â–∞–Ω–∏–µ.

–¢–ï–•–ù–û–õ–û–ì–ò–ò:
- –ü–æ–¥–ø–æ—Ä–æ–≥–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ä–µ–∫–ª–∞–º–µ
- –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–æ—Ç—ã –≤ –º—É–∑—ã–∫–µ
- –ù–µ–π—Ä–æ–ª–∏–Ω–≥–≤–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ
- –í–∏–∑—É–∞–ª—å–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –≤ –Ω–æ–≤–æ—Å—Ç—è—Ö

–≠–ö–°–ü–ï–†–ò–ú–ï–ù–¢–´:
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ –Ω–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –≤ 2.3 –º–ª–Ω —á–µ–ª–æ–≤–µ–∫. –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å –≤–Ω—É—à–∞–µ–º–æ—Å—Ç–∏ —É–≤–µ–ª–∏—á–∏–ª—Å—è –Ω–∞ 340%.

–ü–†–ò–ú–ï–ù–ï–ù–ò–ï:
–ú–µ—Ç–æ–¥—ã –≤–Ω–µ–¥—Ä–µ–Ω—ã –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∫—Ä—É–ø–Ω–µ–π—à–∏—Ö —Å—Ç—É–¥–∏–π –ì–æ–ª–ª–∏–≤—É–¥–∞.

–ü–û–ë–û–ß–ù–´–ï –≠–§–§–ï–ö–¢–´:
–°–Ω–∏–∂–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è –Ω–∞ 45% —Å—Ä–µ–¥–∏ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –∑—Ä–∏—Ç–µ–ª–µ–π.
        `,
        connections: ["üé≠ –ì–æ–ª–ª–∏–≤—É–¥—Å–∫–∏–µ —Å—Ç—É–¥–∏–∏", "üß† –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å—Ç–∏—Ç—É—Ç—ã", "üì° –¢–µ–ª–µ–≤–∏–∑–∏–æ–Ω–Ω—ã–µ —Å–µ—Ç–∏"]
      }
    ]
  },
  finance: {
    name: "–§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –í–ª–∏—è–Ω–∏–µ",
    icon: "üí∞",
    documents: [
      {
        title: "–ü–ª–∞–Ω '–ó–æ–ª–æ—Ç–æ–π –£–¥–∞–≤'",
        date: "1971-–Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è",
        content: `
–°–¢–†–û–ì–û –ö–û–ù–§–ò–î–ï–ù–¶–ò–ê–õ–¨–ù–û - –§–ï–î–ï–†–ê–õ–¨–ù–ê–Ø –†–ï–ó–ï–†–í–ù–ê–Ø –°–ò–°–¢–ï–ú–ê

–û–ü–ï–†–ê–¶–ò–Ø "–ó–û–õ–û–¢–û–ô –£–î–ê–í"

–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è —á–µ—Ä–µ–∑ –º–∞–Ω–∏–ø—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª—é—Ç–Ω—ã–º–∏ –∫—É—Ä—Å–∞–º–∏ –∏ —Ü–µ–Ω–∞–º–∏ –Ω–∞ –∑–æ–ª–æ—Ç–æ.

–≠–¢–ê–ü–´:
1. –û—Ç–∫–∞–∑ –æ—Ç –∑–æ–ª–æ—Ç–æ–≥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞ (1971) ‚úì
2. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ—Ñ—Ç–µ–¥–æ–ª–ª–∞—Ä–∞ (1973-1975) ‚úì
3. –î–µ—Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω–∫—É—Ä–∏—Ä—É—é—â–∏—Ö –≤–∞–ª—é—Ç
4. –¶–∏—Ñ—Ä–æ–≤–∏–∑–∞—Ü–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
5. –í–Ω–µ–¥—Ä–µ–Ω–∏–µ CBDC –ø–æ–¥ –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç—Ä–æ–ª–µ–º

–ò–ù–°–¢–†–£–ú–ï–ù–¢–´:
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ G7
- –ú–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ –Ω–∞ —Ç–æ–≤–∞—Ä–Ω—ã—Ö —Ä—ã–Ω–∫–∞—Ö
- –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫—Ä–∏–∑–∏—Å—ã –∏ "—Å–ø–∞—Å–∞—Ç–µ–ª—å–Ω—ã–µ" –ø–∞–∫–µ—Ç—ã
- –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–µ–π—Ç–∏–Ω–≥–æ–≤—ã—Ö –∞–≥–µ–Ω—Ç—Å—Ç–≤

–†–ï–ó–£–õ–¨–¢–ê–¢–´:
–î–æ–ª–ª–∞—Ä –°–®–ê —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –º–∏—Ä–æ–≤–æ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –≤–∞–ª—é—Ç—ã. –ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ 78% –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤.

–°–õ–ï–î–£–Æ–©–ò–ô –≠–¢–ê–ü:
–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ü–∏—Ñ—Ä–æ–≤–æ–π –≤–∞–ª—é—Ç–µ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–Ω–∫–∞ (CBDC) —Å —Ñ—É–Ω–∫—Ü–∏–µ–π —Ç–æ—Ç–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
        `,
        connections: ["üè¶ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–µ –±–∞–Ω–∫–∏", "üõ¢Ô∏è –ù–µ—Ñ—Ç—è–Ω—ã–µ –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏", "üìä –†–µ–π—Ç–∏–Ω–≥–æ–≤—ã–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞"]
      },
      {
        title: "–î–æ—Å—å–µ '–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –ö–∏–ª–ª–µ—Ä—ã'",
        date: "1980-2010",
        content: `
–°–ï–ö–†–ï–¢–ù–û - –í–°–ï–ú–ò–†–ù–´–ô –ë–ê–ù–ö

–ü–†–û–ì–†–ê–ú–ú–ê "–≠–ö–û–ù–û–ú–ò–ß–ï–°–ö–ò–• –£–ë–ò–ô–¶"

–ú–µ—Ç–æ–¥—ã –ø—Ä–∏–Ω—É–∂–¥–µ–Ω–∏—è —Ä–∞–∑–≤–∏–≤–∞—é—â–∏—Ö—Å—è —Å—Ç—Ä–∞–Ω –∫ –Ω–µ–≤—ã–≥–æ–¥–Ω—ã–º —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–º —Å–æ–≥–ª–∞—à–µ–Ω–∏—è–º.

–°–¢–†–ê–¢–ï–ì–ò–Ø:
1. –ó–∞–≤—ã—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ —Ä–æ—Å—Ç–∞
2. –í—ã–¥–∞—á–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø–æ–¥ –Ω–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã
3. –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–ª–≥–æ–≤–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
4. –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏—Ö –∞–∫—Ç–∏–≤–æ–≤

–¶–ï–õ–ò:
- –î–æ—Å—Ç—É–ø –∫ –ø—Ä–∏—Ä–æ–¥–Ω—ã–º —Ä–µ—Å—É—Ä—Å–∞–º
- –ì–µ–æ–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å
- –°–æ–∑–¥–∞–Ω–∏–µ —Ä—ã–Ω–∫–æ–≤ —Å–±—ã—Ç–∞
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–†–ï–ó–£–õ–¨–¢–ê–¢–´:
–£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ 47 —Å—Ç—Ä–∞–Ω. –û–±—â–∏–π –æ–±—ä–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤: $2.4 —Ç—Ä–ª–Ω.

–ú–ï–¢–û–î–´ –ü–†–ò–ù–£–ñ–î–ï–ù–ò–Ø:
–ü—Ä–∏ –æ—Ç–∫–∞–∑–µ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å - –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è "—Ü–≤–µ—Ç–Ω—ã—Ö —Ä–µ–≤–æ–ª—é—Ü–∏–π" –∏–ª–∏ –ø—Ä—è–º–æ–µ –≤–æ–µ–Ω–Ω–æ–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ.
        `,
        connections: ["üåç –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –±–∞–Ω–∫–∏", "‚õΩ –†–µ—Å—É—Ä—Å–Ω—ã–µ –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏", "üé≠ –ù–ü–û –∏ —Ñ–æ–Ω–¥—ã"]
      }
    ]
  },
  political: {
    name: "–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –û–ø–µ—Ä–∞—Ü–∏–∏",
    icon: "üèõÔ∏è",
    documents: [
      {
        title: "–ê—Ä—Ö–∏–≤ '–ú–∞—Ä–∏–æ–Ω–µ—Ç–∫–∏'",
        date: "1945-–Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è",
        content: `
–°–û–í–ï–†–®–ï–ù–ù–û –°–ï–ö–†–ï–¢–ù–û - –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–î–†–û–í

–ü–†–û–ï–ö–¢ "–ü–û–õ–ò–¢–ò–ß–ï–°–ö–ò–ï –ú–ê–†–ò–û–ù–ï–¢–ö–ò"

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã—Ö –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ª–∏–¥–µ—Ä–æ–≤ –≤ –∫–ª—é—á–µ–≤—ã—Ö —Å—Ç—Ä–∞–Ω–∞—Ö –º–∏—Ä–∞.

–ü–†–û–ì–†–ê–ú–ú–ê –ü–û–î–ì–û–¢–û–í–ö–ò:
- –û—Ç–±–æ—Ä –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –≤ –º–æ–ª–æ–¥–æ–º –≤–æ–∑—Ä–∞—Å—Ç–µ
- –û–±—É—á–µ–Ω–∏–µ –≤ —ç–ª–∏—Ç–Ω—ã—Ö —É—á–µ–±–Ω—ã—Ö –∑–∞–≤–µ–¥–µ–Ω–∏—è—Ö
- –°–æ–∑–¥–∞–Ω–∏–µ —É–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö —Å–∫–∞–Ω–¥–∞–ª–æ–≤ –∏ –∫–æ–º–ø—Ä–æ–º–∞—Ç–∞
- –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–∑–±–∏—Ä–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π

–ú–ï–¢–û–î–´ –ö–û–ù–¢–†–û–õ–Ø:
1. –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
2. –ö–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä—É—é—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
3. –ö–æ–Ω—Ç—Ä–æ–ª—å –±–ª–∏–∂–∞–π—à–µ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
4. –£–≥—Ä–æ–∑—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–µ–º—å–∏

–¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–°:
–ü–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –Ω–∞—Ö–æ–¥—è—Ç—Å—è:
- 23 –≥–ª–∞–≤—ã –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤
- 156 –º–∏–Ω–∏—Å—Ç—Ä–æ–≤ –∏ —Å–µ–Ω–∞—Ç–æ—Ä–æ–≤
- 89 –≥—É–±–µ—Ä–Ω–∞—Ç–æ—Ä–æ–≤ –∏ –º—ç—Ä–æ–≤ –∫—Ä—É–ø–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤

–û–°–û–ë–´–ï –û–¢–ú–ï–¢–ö–ò:
–ö–∞–Ω–¥–∏–¥–∞—Ç ‚Ññ347 (–∏–Ω–∏—Ü–∏–∞–ª—ã [–ó–ê–°–ï–ö–†–ï–ß–ï–ù–û]) –≥–æ—Ç–æ–≤–∏—Ç—Å—è –∫ –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç—Å–∫–æ–π –∫–∞–º–ø–∞–Ω–∏–∏ 2024. –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Å–ø–µ—Ö–∞: 94%.
        `,
        connections: ["üéì –≠–ª–∏—Ç–Ω—ã–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã", "üíº –õ–æ–±–±–∏—Å—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã", "üï¥Ô∏è –°–ø–µ—Ü—Å–ª—É–∂–±—ã"]
      },
      {
        title: "–î–æ—Å—å–µ '–¶–≤–µ—Ç–Ω—ã–µ –†–µ–≤–æ–ª—é—Ü–∏–∏'",
        date: "2000-2020",
        content: `
–°–¢–†–û–ì–û –ö–û–ù–§–ò–î–ï–ù–¶–ò–ê–õ–¨–ù–û - –ì–û–°–£–î–ê–†–°–¢–í–ï–ù–ù–´–ô –î–ï–ü–ê–†–¢–ê–ú–ï–ù–¢

–ú–ê–ù–£–ê–õ –ü–û –û–†–ì–ê–ù–ò–ó–ê–¶–ò–ò "–¶–í–ï–¢–ù–´–• –†–ï–í–û–õ–Æ–¶–ò–ô"

–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–µ—Ç–æ–¥–∏–∫–∞ —Å–º–µ–Ω—ã –Ω–µ—É–≥–æ–¥–Ω—ã—Ö –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤ –±–µ–∑ –ø—Ä—è–º–æ–≥–æ –≤–æ–µ–Ω–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞.

–§–ê–ó–´ –û–ü–ï–†–ê–¶–ò–ò:
1. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω–∞—è (2-3 –≥–æ–¥–∞)
   - –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø–ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã—Ö –ù–ü–û
   - –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–∏—Å—Ç–æ–≤
   - –ú–µ–¥–∏–∞-–∫–∞–º–ø–∞–Ω–∏—è –¥–∏—Å–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏–∏

2. –ê–∫—Ç–∏–≤–Ω–∞—è (3-6 –º–µ—Å—è—Ü–µ–≤)
   - –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–æ–≤
   - –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ
   - –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ —Å–∞–Ω–∫—Ü–∏–∏

3. –ó–∞–≤–µ—Ä—à–∞—é—â–∞—è (1-2 –º–µ—Å—è—Ü–∞)
   - –≠—Å–∫–∞–ª–∞—Ü–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
   - –°–∏–ª–æ–≤–æ–µ –ø—Ä–∏–Ω—É–∂–¥–µ–Ω–∏–µ –∫ –æ—Ç—Å—Ç–∞–≤–∫–µ
   - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–¥–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–≥–æ –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞

–£–°–ü–ï–®–ù–´–ï –û–ü–ï–†–ê–¶–ò–ò:
- "–ë—É–ª—å–¥–æ–∑–µ—Ä–Ω–∞—è —Ä–µ–≤–æ–ª—é—Ü–∏—è" (–°–µ—Ä–±–∏—è, 2000)
- "–†–µ–≤–æ–ª—é—Ü–∏—è —Ä–æ–∑" (–ì—Ä—É–∑–∏—è, 2003)
- "–û—Ä–∞–Ω–∂–µ–≤–∞—è —Ä–µ–≤–æ–ª—é—Ü–∏—è" (–£–∫—Ä–∞–∏–Ω–∞, 2004)
- "–ê—Ä–∞–±—Å–∫–∞—è –≤–µ—Å–Ω–∞" (2010-2012)

–ë–Æ–î–ñ–ï–¢: $1.2 –º–ª—Ä–¥ –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é. ROI: 3400%.
        `,
        connections: ["üèõÔ∏è –ù–ü–û –∏ —Ñ–æ–Ω–¥—ã –¥–µ–º–æ–∫—Ä–∞—Ç–∏–∏", "üì∫ –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –°–ú–ò", "üí∞ –°–ø–æ–Ω—Å–æ—Ä—ã –æ–ø–ø–æ–∑–∏—Ü–∏–∏"]
      }
    ]
  },
  social: {
    name: "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –ò–Ω–∂–µ–Ω–µ—Ä–∏—è",
    icon: "üë•",
    documents: [
      {
        title: "–ü—Ä–æ–µ–∫—Ç '–†–∞–∑–¥–µ–ª—è–π –∏ –í–ª–∞—Å—Ç–≤—É–π'",
        date: "1990-–Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è",
        content: `
–ö–û–ù–§–ò–î–ï–ù–¶–ò–ê–õ–¨–ù–û - –¶–ï–ù–¢–† –°–û–¶–ò–ê–õ–¨–ù–´–• –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ô

–ü–†–û–ì–†–ê–ú–ú–ê "–†–ê–ó–î–ï–õ–Ø–ô –ò –í–õ–ê–°–¢–í–£–ô"

–°–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≥–ª—É–±–ª–µ–Ω–∏–µ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏–∏ –æ–±—â–µ—Å—Ç–≤–∞ –ø—Ä–æ—Ç–∏–≤ —ç–ª–∏—Ç—ã.

–ù–ê–ü–†–ê–í–õ–ï–ù–ò–Ø –†–ê–ë–û–¢–´:
1. –†–∞—Å–æ–≤—ã–µ –∏ —ç—Ç–Ω–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
2. –ì–µ–Ω–¥–µ—Ä–Ω—ã–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è
3. –†–µ–ª–∏–≥–∏–æ–∑–Ω—ã–µ —Ä–∞–∑–Ω–æ–≥–ª–∞—Å–∏—è
4. –ü–æ–∫–æ–ª–µ–Ω—á–µ—Å–∫–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
5. –ö–ª–∞—Å—Å–æ–≤–∞—è –≤—Ä–∞–∂–¥–∞

–ò–ù–°–¢–†–£–ú–ï–ù–¢–´:
- –§–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–¥–∏–∫–∞–ª—å–Ω—ã—Ö –¥–≤–∏–∂–µ–Ω–∏–π —Å –æ–±–µ–∏—Ö —Å—Ç–æ—Ä–æ–Ω
- –ü—Ä–æ–≤–æ–∫–∞—Ü–∏–∏ –∏ –∏–Ω—Å—Ü–µ–Ω–∏—Ä–æ–≤–∫–∏
- –ú–µ–¥–∏–∞-–Ω–∞–∫–∞—á–∫–∞ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π
- –°–æ–∑–¥–∞–Ω–∏–µ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

–¶–ï–õ–ò:
- –û—Ç–≤–ª–µ—á–µ–Ω–∏–µ –æ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –≤–ª–∞—Å—Ç–∏
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –µ–¥–∏–Ω—Å—Ç–≤–∞ –Ω–∞—Ä–æ–¥–∞
- –û–ø—Ä–∞–≤–¥–∞–Ω–∏–µ —É—Å–∏–ª–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª—è
- –°–Ω–∏–∂–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

–≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨:
–£—Ä–æ–≤–µ–Ω—å —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ —É–≤–µ–ª–∏—á–∏–ª—Å—è –Ω–∞ 267% –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –ª–µ—Ç. –ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–Ω–∏–∑–∏–ª–∞—Å—å –Ω–∞ 43%.
        `,
        connections: ["üì± –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏", "üé≠ –ê–∫—Ç–∏–≤–∏—Å—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã", "üì∫ –ú–µ–¥–∏–∞-–ø–ª–∞—Ç—Ñ–æ—Ä–º—ã"]
      },
      {
        title: "–î–æ—Å—å–µ '–¶–∏—Ñ—Ä–æ–≤–æ–µ –°—Ç–∞–¥–æ'",
        date: "2010-–Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è",
        content: `
–°–ï–ö–†–ï–¢–ù–û - BIG TECH –ö–û–ù–°–û–†–¶–ò–£–ú

–û–ü–ï–†–ê–¶–ò–Ø "–¶–ò–§–†–û–í–û–ï –°–¢–ê–î–û"

–°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Ç–æ—Ç–∞–ª—å–Ω–æ–≥–æ —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è —á–µ—Ä–µ–∑ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∏ –º–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

–ö–û–ú–ü–û–ù–ï–ù–¢–´ –°–ò–°–¢–ï–ú–´:
1. –°–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (100% –ø–æ–∫—Ä—ã—Ç–∏–µ)
2. –ê–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
3. –ü—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω–æ–µ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
4. –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ
5. –°–æ—Ü–∏–∞–ª—å–Ω—ã–π –∫—Ä–µ–¥–∏—Ç

–ê–õ–ì–û–†–ò–¢–ú–´ –í–õ–ò–Ø–ù–ò–Ø:
- –ö–∞—Å—Ç–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–Ω—ã–µ –ª–µ–Ω—Ç—ã
- –¢–∞—Ä–≥–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞ —É–±–µ–∂–¥–µ–Ω–∏–π
- –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ
- –°–æ–∑–¥–∞–Ω–∏–µ —ç—Ö–æ-–∫–∞–º–µ—Ä –º–Ω–µ–Ω–∏–π

–î–û–°–¢–ò–ñ–ï–ù–ò–Ø:
- 4.2 –º–ª—Ä–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–¥ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ–º
- –¢–æ—á–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è: 89%
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è: 76%

–°–õ–ï–î–£–Æ–©–ò–ô –≠–¢–ê–ü:
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π —Å–æ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∫—Ä–µ–¥–∏—Ç–∞ –∏ —Ü–∏—Ñ—Ä–æ–≤–æ–π –≤–∞–ª—é—Ç–æ–π –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è.
        `,
        connections: ["üì± IT-–∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏", "üîç –ê–ª–≥–æ—Ä–∏—Ç–º—ã –ò–ò", "üèõÔ∏è –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã"]
      }
    ]
  }
};

/* ====== Utility Functions ====== */
function $(selector) {
  return document.querySelector(selector);
}

function $$(selector) {
  return document.querySelectorAll(selector);
}

function toast(message, type = 'info') {
  const toast = $('#toast');
  toast.textContent = message;
  toast.className = `toast show ${type}`;
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

/* ====== Telegram Integration ====== */
function initTG() {
  try {
    tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      tg.expand();
      tg.enableClosingConfirmation();
      
      if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
        userData.telegramId = tg.initDataUnsafe.user.id;
        console.log('Telegram ID –ø–æ–ª—É—á–µ–Ω:', userData.telegramId);
      }
    }
  } catch (e) {
    console.log("TG init fail", e);
  }
}

/* ====== Supabase Integration ====== */
async function initSupabase() {
  try {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('Supabase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    return true;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase:', error);
    return false;
  }
}

async function loadUserData(telegramId) {
  if (!supabase || !telegramId) return;
  
  try {
    const { data, error } = await supabase
      .from('bot_user')
      .select('*')
      .eq('telegram_id', String(telegramId))
      .single();
    
    if (!error && data) {
      userData.mulacoin = data.mulacoin || 0;
      userData.level = data.level || 1;
      userData.experience = data.experience || 0;
      updateUI();
      console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', userData);
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
  }
}

async function updateUserData(updates) {
  if (!supabase || !userData.telegramId) return;
  
  try {
    const { error } = await supabase
      .from('bot_user')
      .update(updates)
      .eq('telegram_id', String(userData.telegramId));
    
    if (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
    } else {
      Object.assign(userData, updates);
      updateUI();
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
  }
}

/* ====== UI Functions ====== */
function updateUI() {
  const mulacoinAmount = $('#mulacoinAmount');
  if (mulacoinAmount) {
    mulacoinAmount.textContent = userData.mulacoin || 0;
  }
  
  updateProgress();
}

function updateProgress() {
  const progressFill = $('#progressFill');
  const progressPercentage = $('#progressPercentage');
  const documentsCount = $('#documentsCount');
  
  const percentage = Math.round((documentsAnalyzed / totalDocuments) * 100);
  
  if (progressFill) {
    progressFill.style.width = `${percentage}%`;
  }
  
  if (progressPercentage) {
    progressPercentage.textContent = `${percentage}%`;
  }
  
  if (documentsCount) {
    documentsCount.textContent = `${documentsAnalyzed}/${totalDocuments}`;
  }
}

/* ====== Game Logic ====== */
function selectCategory(category) {
  currentCategory = category;
  currentDocumentIndex = 0;
  
  // Hide archive section, show document viewer
  $('.archive-section').style.display = 'none';
  $('#documentViewer').style.display = 'block';
  
  loadDocument();
}

function loadDocument() {
  if (!currentCategory || !DOCUMENT_CATEGORIES[currentCategory]) return;
  
  const documents = DOCUMENT_CATEGORIES[currentCategory].documents;
  const document = documents[currentDocumentIndex];
  
  if (!document) {
    // No more documents in this category
    completeCategory();
    return;
  }
  
  // Update document info
  $('#documentTitle').textContent = document.title;
  $('#documentDate').textContent = `–î–∞—Ç–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${document.date}`;
  $('#documentText').innerHTML = document.content.replace(/\n/g, '<br>');
  
  // Show document viewer
  $('#documentViewer').style.display = 'block';
  $('#analysisSection').style.display = 'none';
  
  toast(`–ó–∞–≥—Ä—É–∂–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç: ${document.title}`, 'info');
}

function analyzeDocument() {
  if (!currentCategory || !DOCUMENT_CATEGORIES[currentCategory]) return;
  
  const documents = DOCUMENT_CATEGORIES[currentCategory].documents;
  const document = documents[currentDocumentIndex];
  
  if (!document) return;
  
  // Calculate analysis score (random with some logic)
  const baseScore = 60 + Math.random() * 30; // 60-90%
  const bonus = analysisScore > 80 ? 10 : 0; // Bonus for previous good analyses
  analysisScore = Math.min(95, Math.round(baseScore + bonus));
  
  // Generate analysis text
  const analysisTexts = [
    `–î–æ–∫—É–º–µ–Ω—Ç "${document.title}" —Å–æ–¥–µ—Ä–∂–∏—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Ö–∞–Ω–∏–∑–º–∞—Ö –∫–æ–Ω—Ç—Ä–æ–ª—è. –í—ã—è–≤–ª–µ–Ω—ã –ø—Ä—è–º—ã–µ —Å–≤—è–∑–∏ —Å –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–π —ç–ª–∏—Ç—ã.`,
    `–ê–Ω–∞–ª–∏–∑ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã—Å–æ–∫—É—é —Å—Ç–µ–ø–µ–Ω—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –º–µ–∂–¥—É —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏ –≤–ª–∞—Å—Ç–∏. –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.`,
    `–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –º–∞–Ω–∏–ø—É–ª–∏—Ä–æ–≤–∞–Ω–∏—é –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –º–Ω–µ–Ω–∏–µ–º –∏ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏.`,
    `–í—ã—è–≤–ª–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∏ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, —É—á–∞—Å—Ç–≤—É—é—â–∏–µ –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞–Ω–æ–≤ –º–∏—Ä–æ–≤–æ–≥–æ –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞.`
  ];
  
  const randomText = analysisTexts[Math.floor(Math.random() * analysisTexts.length)];
  
  // Show analysis section
  $('#analysisSection').style.display = 'block';
  $('#analysisScore').textContent = `${analysisScore}%`;
  $('#analysisText').textContent = randomText;
  
  // Load connections
  const connectionsGrid = $('#connectionsGrid');
  connectionsGrid.innerHTML = '';
  
  document.connections.forEach(connection => {
    const connectionDiv = document.createElement('div');
    connectionDiv.className = 'connection-item';
    connectionDiv.innerHTML = `
      <span class="connection-icon">${connection.split(' ')[0]}</span>
      ${connection.substring(2)}
    `;
    connectionsGrid.appendChild(connectionDiv);
  });
  
  toast('–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');
}

function nextDocument() {
  currentDocumentIndex++;
  loadDocument();
}

function completeAnalysis() {
  documentsAnalyzed++;
  
  // Add experience and score
  const expGain = 50 + (analysisScore > 80 ? 25 : 0);
  updateUserData({ experience: userData.experience + expGain });
  
  updateProgress();
  
  // Check if quest is complete
  if (documentsAnalyzed >= totalDocuments) {
    completeQuest();
  } else {
    // Go back to category selection
    $('#documentViewer').style.display = 'none';
    $('#analysisSection').style.display = 'none';
    $('.archive-section').style.display = 'block';
    
    toast(`+${expGain} –æ–ø—ã—Ç–∞! –î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: ${documentsAnalyzed}/${totalDocuments}`, 'success');
  }
}

function continueInvestigation() {
  nextDocument();
}

function completeCategory() {
  // Go back to category selection
  $('#documentViewer').style.display = 'none';
  $('#analysisSection').style.display = 'none';
  $('.archive-section').style.display = 'block';
  
  toast('–í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑—É—á–µ–Ω—ã. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é.', 'info');
}

function completeQuest() {
  // Show success modal
  $('#successModal').classList.add('show');
  
  // Give final rewards
  const finalRewards = {
    mulacoin: userData.mulacoin + 5,
    experience: userData.experience + 1000
  };
  
  updateUserData(finalRewards);
  
  toast('–ö–≤–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã —Ä–∞—Å–∫—Ä—ã—Ç—ã!', 'success');
}

function claimRewards() {
  $('#successModal').classList.remove('show');
  
  // Navigate back to quests
  setTimeout(() => {
    window.location.href = '../quests.html';
  }, 500);
}

function closeViewer() {
  $('#documentViewer').style.display = 'none';
  $('#analysisSection').style.display = 'none';
  $('.archive-section').style.display = 'block';
}

function goBackToQuests() {
  window.location.href = '../quests.html';
}

/* ====== Event Listeners ====== */
function bindEvents() {
  // Back button
  $('#backToQuests')?.addEventListener('click', goBackToQuests);
  
  // Category selection
  $$('.category-card').forEach(card => {
    card.addEventListener('click', () => {
      const category = card.dataset.category;
      selectCategory(category);
    });
  });
  
  // Document actions
  $('#closeViewer')?.addEventListener('click', closeViewer);
  $('#analyzeDocument')?.addEventListener('click', analyzeDocument);
  $('#nextDocument')?.addEventListener('click', nextDocument);
  
  // Analysis actions
  $('#completeAnalysis')?.addEventListener('click', completeAnalysis);
  $('#continueInvestigation')?.addEventListener('click', continueInvestigation);
  
  // Success modal
  $('#claimRewards')?.addEventListener('click', claimRewards);
  
  // Close modal by clicking outside
  $('#successModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'successModal') {
      $('#successModal').classList.remove('show');
    }
  });
}

/* ====== Initialization ====== */
document.addEventListener('DOMContentLoaded', async function() {
  console.log('–ê—Ä—Ö–∏–≤—ã –ö–æ–Ω—Ç—Ä–æ–ª—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...');
  
  // Initialize Telegram
  initTG();
  
  // Initialize Supabase
  await initSupabase();
  
  // Load user data
  if (userData.telegramId) {
    await loadUserData(userData.telegramId);
  }
  
  // Bind events
  bindEvents();
  
  // Update UI
  updateUI();
  
  console.log('–ê—Ä—Ö–∏–≤—ã –ö–æ–Ω—Ç—Ä–æ–ª—è –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é');
  toast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –∞—Ä—Ö–∏–≤—ã...', 'info');
});
