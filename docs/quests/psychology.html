<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üíÄ –ú–µ—Ç–æ–¥—ã –≠–ø—à—Ç–µ–π–Ω–∞ - –¢–∞–π–Ω–∞—è –ê–∫–∞–¥–µ–º–∏—è</title>
  <link rel="stylesheet" href="quests-black-white.css">
  <style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–≤–µ—Å—Ç–∞ "–ú–µ—Ç–æ–¥—ã –≠–ø—à—Ç–µ–π–Ω–∞" */
    :root {
      --epstein-gold: #ffd700;
      --epstein-dark: #1a0d00;
      --epstein-red: #8b0000;
      --shadow-elite: #2d1810;
      --manipulation-glow: rgba(255, 215, 0, 0.3);
    }

    .quest-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, var(--epstein-dark), var(--shadow-elite));
      border-radius: 20px;
      border: 2px solid var(--epstein-gold);
      box-shadow: 0 0 30px var(--manipulation-glow);
    }

    .target-card {
      background: var(--glass);
      border: 1px solid var(--epstein-gold);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }

    .target-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--epstein-gold), var(--epstein-red));
    }

    .target-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid var(--epstein-gold);
      object-fit: cover;
      margin-bottom: 16px;
    }

    .target-name {
      font-size: 24px;
      font-weight: 700;
      color: var(--epstein-gold);
      margin-bottom: 8px;
      text-shadow: 0 0 10px var(--manipulation-glow);
    }

    .target-role {
      font-size: 16px;
      color: var(--text-muted);
      margin-bottom: 16px;
      font-style: italic;
    }

    .manipulation-technique {
      background: rgba(255, 215, 0, 0.1);
      border: 1px solid var(--epstein-gold);
      border-radius: 12px;
      padding: 16px;
      margin: 12px 0;
      transition: all 0.3s ease;
    }

    .manipulation-technique:hover {
      background: rgba(255, 215, 0, 0.2);
      box-shadow: 0 0 15px var(--manipulation-glow);
    }

    .technique-name {
      font-weight: 600;
      color: var(--epstein-gold);
      margin-bottom: 8px;
      font-size: 16px;
    }

    .technique-description {
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
    }

    .session-results {
      background: var(--epstein-dark);
      border: 1px solid var(--epstein-red);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .influence-meter {
      width: 100%;
      height: 20px;
      background: var(--bg2);
      border-radius: 10px;
      overflow: hidden;
      margin: 16px 0;
    }

    .influence-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--epstein-red), var(--epstein-gold));
      transition: width 1s ease;
      position: relative;
    }

    .influence-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .control-button {
      background: linear-gradient(135deg, var(--epstein-gold), #ffed4a);
      color: var(--epstein-dark);
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 8px;
      font-size: 14px;
    }

    .control-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px var(--manipulation-glow);
    }

    .control-button:disabled {
      background: var(--bg2);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .psychological-profile {
      background: rgba(139, 0, 0, 0.1);
      border: 1px solid var(--epstein-red);
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0;
    }

    .profile-trait {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0;
      padding: 8px;
      background: rgba(0,0,0,0.3);
      border-radius: 6px;
    }

    .trait-name {
      color: var(--text);
      font-weight: 500;
    }

    .trait-value {
      color: var(--epstein-gold);
      font-weight: 600;
    }

    .phase-indicator {
      text-align: center;
      margin: 30px 0;
      padding: 20px;
      background: var(--glass);
      border-radius: 15px;
      border: 1px solid var(--epstein-gold);
    }

    .phase-title {
      font-size: 20px;
      color: var(--epstein-gold);
      margin-bottom: 8px;
      font-weight: 700;
    }

    .phase-subtitle {
      color: var(--text-muted);
      font-size: 14px;
    }

    .completion-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .completion-content {
      background: linear-gradient(135deg, var(--epstein-dark), var(--shadow-elite));
      border: 2px solid var(--epstein-gold);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 0 50px var(--manipulation-glow);
    }

    .completion-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }

    .completion-title {
      font-size: 28px;
      color: var(--epstein-gold);
      margin-bottom: 16px;
      font-weight: 700;
    }

    .completion-description {
      color: var(--text);
      margin-bottom: 30px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div id="app" class="app">
    <header class="glass topbar">
      <div class="brand">
        <span class="logoGlow"></span>
        <h1>üíÄ –ú–µ—Ç–æ–¥—ã –≠–ø—à—Ç–µ–π–Ω–∞</h1>
        <div class="badge">–ü—Å–∏—Ö–æ–∫–æ–Ω—Ç—Ä–æ–ª—å</div>
      </div>
      <div class="actions">
        <button id="btnBack" class="btn ghost">‚Üê –ù–∞–∑–∞–¥</button>
      </div>
    </header>

    <div class="quest-container">
      <div class="phase-indicator">
        <div class="phase-title">üß† –ê–∫–∞–¥–µ–º–∏—è –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ö–æ–Ω—Ç—Ä–æ–ª—è</div>
        <div class="phase-subtitle">–ò–∑—É—á–∏—Ç–µ –º–µ—Ç–æ–¥—ã –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ —ç–ª–∏—Ç—É –∏ –≤–ª–∏—è—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω</div>
      </div>

      <!-- –í—ã–±–æ—Ä —Ü–µ–ª–∏ -->
      <div id="targetSelection" class="target-selection">
        <h2 style="color: var(--epstein-gold); text-align: center; margin-bottom: 30px;">
          üéØ –í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å –¥–ª—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è
        </h2>
        <div id="targetsList" class="targets-list"></div>
      </div>

      <!-- –°–µ—Å—Å–∏—è –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è -->
      <div id="sessionPhase" class="session-phase" style="display: none;">
        <div id="currentTarget" class="target-card"></div>
        
        <div class="psychological-profile">
          <h3 style="color: var(--epstein-gold); margin-bottom: 16px;">üìä –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å</h3>
          <div id="profileTraits"></div>
        </div>

        <div style="margin: 30px 0;">
          <h3 style="color: var(--epstein-gold); margin-bottom: 20px;">üé≠ –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è</h3>
          <div id="techniquesContainer"></div>
        </div>

        <div class="session-results" id="sessionResults" style="display: none;">
          <h4 style="color: var(--epstein-gold); margin-bottom: 16px;">üìà –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è</h4>
          <div>–£—Ä–æ–≤–µ–Ω—å –≤–ª–∏—è–Ω–∏—è:</div>
          <div class="influence-meter">
            <div id="influenceFill" class="influence-fill" style="width: 0%;"></div>
          </div>
          <div id="resultText" style="color: var(--text); margin-top: 16px;"></div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="nextSessionBtn" class="control-button">–°–ª–µ–¥—É—é—â–∞—è —Å–µ—Å—Å–∏—è</button>
            <button id="completeTargetBtn" class="control-button" style="display: none;">–ó–∞–≤–µ—Ä—à–∏—Ç—å –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ</button>
          </div>
        </div>
      </div>

      <!-- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–≤–µ—Å—Ç–∞ -->
      <div id="questCompletion" class="completion-modal">
        <div class="completion-content">
          <div class="completion-icon">üî∫</div>
          <h2 class="completion-title">–≠–ª–∏—Ç–∞ –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º!</h2>
          <p class="completion-description">
            –ü—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–æ! –í—ã —É—Å–ø–µ—à–Ω–æ –æ—Å–≤–æ–∏–ª–∏ –ø—Å–∏—Ö–æ—Ç–µ—Ö–Ω–∏–∫–∏ –≠–ø—à—Ç–µ–π–Ω–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∫–ª—é—á–µ–≤—ã–º–∏ —Ñ–∏–≥—É—Ä–∞–º–∏. 
            –í–∞—à–∏ –Ω–∞–≤—ã–∫–∏ –≤–ª–∏—è–Ω–∏—è –¥–æ—Å—Ç–∏–≥–ª–∏ —É—Ä–æ–≤–Ω—è —Ç–µ–Ω–µ–≤–æ–≥–æ –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞.
          </p>
          <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <div style="text-align: center;">
              <div style="color: var(--epstein-gold); font-size: 24px; font-weight: 700;">+5</div>
              <div style="color: var(--text-muted); font-size: 12px;">MULACOIN</div>
            </div>
            <div style="text-align: center;">
              <div style="color: var(--epstein-gold); font-size: 24px; font-weight: 700;">+1000</div>
              <div style="color: var(--text-muted); font-size: 12px;">–û–ü–´–¢</div>
            </div>
          </div>
          <button id="finishQuestBtn" class="control-button" style="width: 100%;">–ó–∞–≤–µ—Ä—à–∏—Ç—å –º–∏—Å—Å–∏—é</button>
        </div>
      </div>
    </div>
  </div>

  <script src="../js/telegram-web-app.js"></script>
  <script src="../js/supabase.js"></script>
  <script>
    // –¶–µ–ª–∏ –¥–ª—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è
    const TARGETS = [
      {
        id: 'mayor',
        name: '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ü–µ—Ç—Ä–æ–≤',
        role: '–ú—ç—Ä –∫—Ä—É–ø–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞',
        avatar: '../assets/avatars/mayor.jpg',
        traits: {
          '–≠–≥–æ': 85,
          '–ñ–∞–¥–Ω–æ—Å—Ç—å': 70,
          '–°—Ç—Ä–∞—Ö–∏': 60,
          '–¢—â–µ—Å–ª–∞–≤–∏–µ': 90,
          '–ö–æ—Ä—Ä—É–ø—Ü–∏—è': 75
        },
        weaknesses: ['–ü—É–±–ª–∏—á–Ω–æ—Å—Ç—å', '–ö–æ–º–ø—Ä–æ–º–∞—Ç', '–°–µ–º—å—è'],
        description: '–í–ª–∏—è—Ç–µ–ª—å–Ω—ã–π –ø–æ–ª–∏—Ç–∏–∫ —Å –∞–º–±–∏—Ü–∏—è–º–∏ –Ω–∞ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å'
      },
      {
        id: 'anchor',
        name: '–ï–ª–µ–Ω–∞ –í–æ–ª–∫–æ–≤–∞',
        role: '–ì–ª–∞–≤–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–ª–µ–∫–∞–Ω–∞–ª–∞',
        avatar: '../assets/avatars/anchor.jpg',
        traits: {
          '–≠–≥–æ': 95,
          '–ñ–∞–¥–Ω–æ—Å—Ç—å': 60,
          '–°—Ç—Ä–∞—Ö–∏': 70,
          '–¢—â–µ—Å–ª–∞–≤–∏–µ': 100,
          '–ö–æ–Ω—Ç—Ä–æ–ª—å': 80
        },
        weaknesses: ['–†–µ–π—Ç–∏–Ω–≥–∏', '–°–∫–∞–Ω–¥–∞–ª—ã', '–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã'],
        description: '–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–ª—è –º–∏–ª–ª–∏–æ–Ω–æ–≤ –∑—Ä–∏—Ç–µ–ª–µ–π'
      },
      {
        id: 'oligarch',
        name: '–î–º–∏—Ç—Ä–∏–π –ó–æ–ª–æ—Ç–∞—Ä–µ–≤',
        role: '–ù–∞—Å–ª–µ–¥–Ω–∏–∫ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–π –∏–º–ø–µ—Ä–∏–∏',
        avatar: '../assets/avatars/oligarch.jpg',
        traits: {
          '–≠–≥–æ': 70,
          '–ñ–∞–¥–Ω–æ—Å—Ç—å': 100,
          '–°—Ç—Ä–∞—Ö–∏': 50,
          '–¢—â–µ—Å–ª–∞–≤–∏–µ': 80,
          '–í–ª–∞—Å—Ç—å': 95
        },
        weaknesses: ['–î–µ–Ω—å–≥–∏', '–†–µ–ø—É—Ç–∞—Ü–∏—è', '–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã'],
        description: '–ú–æ–ª–æ–¥–æ–π –º–∏–ª–ª–∏–∞—Ä–¥–µ—Ä —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –∞–º–±–∏—Ü–∏—è–º–∏'
      },
      {
        id: 'general',
        name: '–ì–µ–Ω–µ—Ä–∞–ª –ñ–µ–ª–µ–∑–æ–≤',
        role: '–ö–æ–º–∞–Ω–¥—É—é—â–∏–π –≤–æ–µ–Ω–Ω—ã–º –æ–∫—Ä—É–≥–æ–º',
        avatar: '../assets/avatars/general.jpg',
        traits: {
          '–≠–≥–æ': 80,
          '–ñ–∞–¥–Ω–æ—Å—Ç—å': 40,
          '–°—Ç—Ä–∞—Ö–∏': 30,
          '–¢—â–µ—Å–ª–∞–≤–∏–µ': 70,
          '–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞': 95
        },
        weaknesses: ['–ß–µ—Å—Ç—å', '–ü–æ–¥—á–∏–Ω–µ–Ω–Ω—ã–µ', '–î–æ–ª–≥'],
        description: '–ö–ª—é—á–µ–≤–∞—è —Ñ–∏–≥—É—Ä–∞ –≤ –≤–æ–µ–Ω–Ω–æ–π –∏–µ—Ä–∞—Ä—Ö–∏–∏ —Å—Ç—Ä–∞–Ω—ã'
      },
      {
        id: 'banker',
        name: '–í–∏–∫—Ç–æ—Ä–∏—è –ü–ª–∞—Ç–∏–Ω–æ–≤–∞',
        role: '–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–Ω–∫–∞',
        avatar: '../assets/avatars/banker.jpg',
        traits: {
          '–≠–≥–æ': 75,
          '–ñ–∞–¥–Ω–æ—Å—Ç—å': 90,
          '–°—Ç—Ä–∞—Ö–∏': 65,
          '–¢—â–µ—Å–ª–∞–≤–∏–µ': 85,
          '–†–∞—Å—á–µ—Ç': 100
        },
        weaknesses: ['–ü—Ä–∏–±—ã–ª—å', '–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å', '–†–µ–≥—É–ª—è—Ç–æ—Ä—ã'],
        description: '–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Ç–æ–∫–∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞'
      }
    ];

    // –¢–µ—Ö–Ω–∏–∫–∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è
    const TECHNIQUES = [
      {
        id: 'paranoia',
        name: '–ü–∞—Ä–∞–Ω–æ–∏–¥–∞–ª—å–Ω–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ',
        description: '–£—Å–∏–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ö–æ–≤ –∏ –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∞—à–µ–≥–æ "–ø–æ–∫—Ä–æ–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞"',
        effectiveness: { '–°—Ç—Ä–∞—Ö–∏': 30, '–≠–≥–æ': -10 },
        risk: 20
      },
      {
        id: 'narcissism',
        name: '–ù–∞—Ä—Ü–∏—Å—Å–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã',
        description: '–õ–µ—Å—Ç—å –∏ –ø–æ–¥–ø–∏—Ç–∫–∞ —ç–≥–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏',
        effectiveness: { '–¢—â–µ—Å–ª–∞–≤–∏–µ': 25, '–≠–≥–æ': 35 },
        risk: 10
      },
      {
        id: 'greed',
        name: '–ñ–∞–¥–Ω–æ—Å—Ç—å –∏ –∞–ª—á–Ω–æ—Å—Ç—å',
        description: '–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤—ã–≥–æ–¥–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –∏ –∏–Ω—Å–∞–π–¥–µ—Ä—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏',
        effectiveness: { '–ñ–∞–¥–Ω–æ—Å—Ç—å': 40, '–†–∞—Å—á–µ—Ç': 20 },
        risk: 30
      },
      {
        id: 'blackmail',
        name: '–°–∫—Ä—ã—Ç–æ–µ –ø—Ä–∏–Ω—É–∂–¥–µ–Ω–∏–µ',
        description: '–ù–∞–º–µ–∫–∏ –Ω–∞ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –±–µ–∑ –ø—Ä—è–º—ã—Ö —É–≥—Ä–æ–∑',
        effectiveness: { '–°—Ç—Ä–∞—Ö–∏': 50, '–ö–æ–Ω—Ç—Ä–æ–ª—å': -20 },
        risk: 50
      },
      {
        id: 'isolation',
        name: '–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è',
        description: '–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –æ—Ç—á—É–∂–¥–µ–Ω–∏–µ –æ—Ç –∫—Ä—É–≥–∞ –¥–æ–≤–µ—Ä–∏—è –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏',
        effectiveness: { '–°—Ç—Ä–∞—Ö–∏': 35, '–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞': -15 },
        risk: 25
      },
      {
        id: 'rewards',
        name: '–°–∏—Å—Ç–µ–º–∞ –ø–æ–æ—â—Ä–µ–Ω–∏–π',
        description: '–°–æ–∑–¥–∞–Ω–∏–µ —É—Å–ª–æ–≤–Ω—ã—Ö —Ä–µ—Ñ–ª–µ–∫—Å–æ–≤ —á–µ—Ä–µ–∑ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ –∏ —Å—Ç–∞—Ç—É—Å–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã',
        effectiveness: { '–ñ–∞–¥–Ω–æ—Å—Ç—å': 30, '–¢—â–µ—Å–ª–∞–≤–∏–µ': 25 },
        risk: 15
      }
    ];

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    let gameState = {
      currentTarget: null,
      sessionCount: 0,
      completedTargets: [],
      totalInfluence: 0,
      questCompleted: false
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      loadTargets();
      bindEvents();
    });

    function bindEvents() {
      document.getElementById('btnBack').addEventListener('click', () => {
        window.location.href = '../quests.html';
      });

      document.getElementById('nextSessionBtn').addEventListener('click', startNewSession);
      document.getElementById('completeTargetBtn').addEventListener('click', completeTarget);
      document.getElementById('finishQuestBtn').addEventListener('click', finishQuest);
    }

    function loadTargets() {
      const targetsList = document.getElementById('targetsList');
      targetsList.innerHTML = '';

      TARGETS.forEach(target => {
        if (!gameState.completedTargets.includes(target.id)) {
          const targetCard = createTargetCard(target);
          targetsList.appendChild(targetCard);
        }
      });
    }

    function createTargetCard(target) {
      const card = document.createElement('div');
      card.className = 'target-card';
      card.style.cursor = 'pointer';
      
      card.innerHTML = `
        <img class="target-avatar" src="${target.avatar}" alt="${target.name}" onerror="this.src='../assets/avatars/default.png'">
        <div class="target-name">${target.name}</div>
        <div class="target-role">${target.role}</div>
        <div class="technique-description">${target.description}</div>
        <div style="margin-top: 16px;">
          <strong style="color: var(--epstein-gold);">–£—è–∑–≤–∏–º–æ—Å—Ç–∏:</strong> ${target.weaknesses.join(', ')}
        </div>
      `;

      card.addEventListener('click', () => selectTarget(target));
      return card;
    }

    function selectTarget(target) {
      gameState.currentTarget = { ...target };
      gameState.sessionCount = 0;
      
      document.getElementById('targetSelection').style.display = 'none';
      document.getElementById('sessionPhase').style.display = 'block';
      
      updateTargetDisplay();
      updateProfileTraits();
      loadTechniques();
    }

    function updateTargetDisplay() {
      const target = gameState.currentTarget;
      const targetCard = document.getElementById('currentTarget');
      
      targetCard.innerHTML = `
        <img class="target-avatar" src="${target.avatar}" alt="${target.name}" onerror="this.src='../assets/avatars/default.png'">
        <div class="target-name">${target.name}</div>
        <div class="target-role">${target.role}</div>
        <div style="color: var(--text-muted); margin-top: 12px;">
          –°–µ—Å—Å–∏—è ${gameState.sessionCount + 1} –∏–∑ 8 ‚Ä¢ –£—Ä–æ–≤–µ–Ω—å –∫–æ–Ω—Ç—Ä–æ–ª—è: ${calculateControlLevel()}%
        </div>
      `;
    }

    function updateProfileTraits() {
      const traitsContainer = document.getElementById('profileTraits');
      traitsContainer.innerHTML = '';

      Object.entries(gameState.currentTarget.traits).forEach(([trait, value]) => {
        const traitElement = document.createElement('div');
        traitElement.className = 'profile-trait';
        traitElement.innerHTML = `
          <span class="trait-name">${trait}</span>
          <span class="trait-value">${Math.max(0, Math.min(100, value))}%</span>
        `;
        traitsContainer.appendChild(traitElement);
      });
    }

    function loadTechniques() {
      const container = document.getElementById('techniquesContainer');
      container.innerHTML = '';

      TECHNIQUES.forEach(technique => {
        const techniqueElement = document.createElement('div');
        techniqueElement.className = 'manipulation-technique';
        techniqueElement.style.cursor = 'pointer';
        
        techniqueElement.innerHTML = `
          <div class="technique-name">${technique.name}</div>
          <div class="technique-description">${technique.description}</div>
          <div style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">
            –†–∏—Å–∫ –ø—Ä–æ–≤–∞–ª–∞: ${technique.risk}%
          </div>
        `;

        techniqueElement.addEventListener('click', () => useTechnique(technique));
        container.appendChild(techniqueElement);
      });
    }

    function useTechnique(technique) {
      const success = Math.random() > (technique.risk / 100);
      let influenceGain = 0;

      if (success) {
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã —Ç–µ—Ö–Ω–∏–∫–∏
        Object.entries(technique.effectiveness).forEach(([trait, change]) => {
          if (gameState.currentTarget.traits[trait] !== undefined) {
            gameState.currentTarget.traits[trait] = Math.max(0, Math.min(100, 
              gameState.currentTarget.traits[trait] + change
            ));
          }
        });
        
        influenceGain = Math.floor(Math.random() * 20) + 10;
        gameState.totalInfluence += influenceGain;
      }

      gameState.sessionCount++;
      showSessionResults(technique, success, influenceGain);
    }

    function showSessionResults(technique, success, influenceGain) {
      const resultsContainer = document.getElementById('sessionResults');
      const resultText = document.getElementById('resultText');
      const influenceFill = document.getElementById('influenceFill');
      
      resultsContainer.style.display = 'block';
      
      if (success) {
        resultText.innerHTML = `
          <div style="color: var(--epstein-gold);">‚úÖ ${technique.name} –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!</div>
          <div style="margin-top: 8px;">–í–ª–∏—è–Ω–∏–µ —É–≤–µ–ª–∏—á–µ–Ω–æ –Ω–∞ ${influenceGain}%. –¶–µ–ª—å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –±–æ–ª–µ–µ –ø–æ–¥–∞—Ç–ª–∏–≤–æ–π –∫ –≤–∞—à–µ–º—É –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—é.</div>
        `;
      } else {
        resultText.innerHTML = `
          <div style="color: var(--epstein-red);">‚ùå ${technique.name} –≤—ã–∑–≤–∞–ª–∞ –ø–æ–¥–æ–∑—Ä–µ–Ω–∏—è!</div>
          <div style="margin-top: 8px;">–¶–µ–ª—å —Å—Ç–∞–ª–∞ –±–æ–ª–µ–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø–æ–¥—Ö–æ–¥.</div>
        `;
      }

      const controlLevel = calculateControlLevel();
      influenceFill.style.width = `${controlLevel}%`;

      updateProfileTraits();
      updateTargetDisplay();

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
      const nextBtn = document.getElementById('nextSessionBtn');
      const completeBtn = document.getElementById('completeTargetBtn');
      
      if (gameState.sessionCount >= 8 || controlLevel >= 80) {
        nextBtn.style.display = 'none';
        completeBtn.style.display = 'inline-block';
      } else {
        nextBtn.style.display = 'inline-block';
        completeBtn.style.display = 'none';
      }
    }

    function calculateControlLevel() {
      const totalSessions = Math.max(1, gameState.sessionCount);
      const influence = gameState.totalInfluence;
      return Math.min(100, Math.floor(influence / totalSessions * 5));
    }

    function startNewSession() {
      document.getElementById('sessionResults').style.display = 'none';
      loadTechniques();
    }

    function completeTarget() {
      gameState.completedTargets.push(gameState.currentTarget.id);
      
      if (gameState.completedTargets.length >= 3) {
        // –ö–≤–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω
        document.getElementById('questCompletion').style.display = 'flex';
      } else {
        // –í–æ–∑–≤—Ä–∞—Ç –∫ –≤—ã–±–æ—Ä—É —Å–ª–µ–¥—É—é—â–µ–π —Ü–µ–ª–∏
        document.getElementById('sessionPhase').style.display = 'none';
        document.getElementById('targetSelection').style.display = 'block';
        loadTargets();
      }
    }

    async function finishQuest() {
      try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–≤–µ—Å—Ç–∞
        if (window.supabase && window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
          const userId = window.Telegram.WebApp.initDataUnsafe.user.id;
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–≤–µ—Å—Ç–∞
          await window.supabase
            .from('quest_completions')
            .insert({
              user_id: userId,
              quest_id: 'psychology',
              completed_at: new Date().toISOString(),
              reward_fragments: 5,
              reward_experience: 1000
            });

          // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          await window.supabase.rpc('add_user_rewards', {
            p_user_id: userId,
            p_fragments: 5,
            p_experience: 1000
          });
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', error);
      }

      // –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
      window.location.href = '../quests.html';
    }
  </script>
</body>
</html>