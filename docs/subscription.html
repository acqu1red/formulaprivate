<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Меню подписки</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
  * { box-sizing: border-box; }
  body { margin: 0; background: #121212; color: #f0eadf; font-family: 'Inter', sans-serif; display:flex; flex-direction:column; min-height:100vh; overflow:hidden; }
  header { background:#1f1f1f; padding:16px 0; text-align:center; position:relative; border:2px solid #d6c7b8; border-radius:12px; margin:12px 16px 8px 16px; flex-shrink:0; }
  header h1 { margin:0; font-weight:700; font-size:1.35rem; }
  main { flex:1; display:flex; flex-direction:column; padding:16px; overflow:auto; gap:16px; }
  .card { background: linear-gradient(135deg, #1f1f1f 0%, #1a1a1a 100%); border: 2px solid #333; border-radius: 16px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,.3); transition: all .3s ease; }
  .card:hover { border-color:#d6c7b8; box-shadow:0 12px 40px rgba(214,199,184,.1); }
  .neon { position: relative; text-align:center; padding:24px 12px; border-radius:16px; border: 2px solid #d6c7b8; color:#f0eadf; background: radial-gradient(ellipse at center, rgba(214,199,184,.08), rgba(0,0,0,0)); box-shadow: 0 0 12px rgba(214,199,184,.25), inset 0 0 18px rgba(214,199,184,.06); animation: neonpulse 3s ease-in-out infinite; }
  .neon h2 { margin:0; font-size:1.4rem; letter-spacing:1px; text-shadow: 0 0 8px rgba(255,255,255,.25); }
  @keyframes neonpulse { 0%{box-shadow:0 0 10px rgba(214,199,184,.25), inset 0 0 12px rgba(214,199,184,.05);} 50%{box-shadow:0 0 22px rgba(214,199,184,.45), inset 0 0 20px rgba(214,199,184,.1);} 100%{box-shadow:0 0 10px rgba(214,199,184,.25), inset 0 0 12px rgba(214,199,184,.05);} }
  .grid { display:grid; gap:12px; }
  .row { display:flex; align-items:center; justify-content:space-between; border-bottom:1px dashed #333; padding:8px 0; }
  .label { color:#a6a8ad; }
  .value { color:#f0eadf; font-weight:600; }
  .cta { display:grid; gap:12px; }
  .btn { padding:16px 24px; border:none; border-radius:12px; font-weight:700; font-size:1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .25s ease; }
  .btn-primary { background: linear-gradient(135deg, #d6c7b8 0%, #f0eadf 100%); color:#121212; box-shadow:0 8px 22px rgba(214,199,184,.35); }
  .btn-primary:hover { transform: translateY(-2px); }
  .small { font-size:.95rem; color:#a6a8ad; text-align:center; }
  .loading { text-align:center; color:#a6a8ad; padding:20px; }
  .error { color:#ff7b7b; text-align:center; }
</style>
</head>
<body>
  <header><h1>Меню подписки</h1></header>
  <main id="app"><div class="loading" id="loading">Загрузка...</div></main>

<script>
const tg = window.Telegram ? window.Telegram.WebApp : null;
if (tg) { tg.ready(); tg.expand(); }

function openPayment(){ const paymentUrl = new URL('payment.html', window.location.href).toString(); window.location.href = paymentUrl; }
function fmtDate(ts){ try{ const d=new Date(ts); return d.toLocaleString('ru-RU'); }catch(e){ return ts; } }
function diffDH(toTs){ const now=Date.now(); const to=new Date(toTs).getTime(); let ms=Math.max(0,to-now); const days=Math.floor(ms/86400000); ms-=days*86400000; const hours=Math.floor(ms/3600000); return {days, hours}; }

async function loadStatus(){
  const app = document.getElementById('app'); const loading=document.getElementById('loading');
  const apiBase = "https://formulaprivate-production.up.railway.app";
  const telegram_id = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) ? tg.initDataUnsafe.user.id : null;
  const init_data = tg ? tg.initData : null;

  const r = await fetch(apiBase + "/api/subscription/status", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ telegram_id, init_data }) });
  const resp = await r.json().catch(()=>({ok:false, error:"Bad JSON"}));
  loading.remove();

  if(!resp.ok){ const e=document.createElement('div'); e.className='error'; e.textContent="Ошибка загрузки статуса: " + (resp.error || "unknown"); app.appendChild(e); return; }

  if(!resp.has_subscription){
    const card=document.createElement('div'); card.className='card neon'; card.innerHTML='<h2>У вас ещё нет подписки</h2>';
    const cta=document.createElement('div'); cta.className='cta';
    const btn=document.createElement('button'); btn.className='btn btn-primary'; btn.textContent='Оформить подписку'; btn.onclick=openPayment;
    cta.appendChild(btn); app.appendChild(card); app.appendChild(cta); app.appendChild(Object.assign(document.createElement('div'), {className:'small', textContent:'Подписка оформляется в пару кликов'})); return;
  }

  const d = resp.data || {}; const expires = d.expires_at || d.next_payment_at || d.started_at; const left = expires ? diffDH(expires) : {days:0,hours:0};
  const block=document.createElement('div'); block.className='card';
  block.innerHTML = `
    <div style="margin-bottom:10px; font-weight:700; font-size:1.1rem;">Данные подписки</div>
    <div class="grid">
      <div class="row"><div class="label">E-mail</div><div class="value">${d.email || '—'}</div></div>
      <div class="row"><div class="label">Telegram ID</div><div class="value">${d.tg_id || '—'}</div></div>
      <div class="row"><div class="label">Username</div><div class="value">${d.username ? '@'+d.username : '—'}</div></div>
      <div class="row"><div class="label">Оформлено</div><div class="value">${fmtDate(d.started_at)}</div></div>
      <div class="row"><div class="label">До окончания</div><div class="value">${left.days} д. ${left.hours} ч.</div></div>
      <div class="row"><div class="label">Следующий платёж</div><div class="value">${fmtDate(d.next_payment_at)}</div></div>
    </div>`;
  const cta=document.createElement('div'); cta.className='cta';
  const linkBtn=document.createElement('a'); linkBtn.className='btn btn-primary'; linkBtn.textContent='Перейти в канал'; linkBtn.href=resp.channel_invite_link || '#'; linkBtn.target='_blank';
  cta.appendChild(linkBtn); const small=document.createElement('div'); small.className='small'; small.textContent='Если ссылка не открывается — напишите в поддержку';
  app.appendChild(block); app.appendChild(cta); app.appendChild(small);
}
document.addEventListener('DOMContentLoaded', loadStatus);
</script>
</body>
</html>