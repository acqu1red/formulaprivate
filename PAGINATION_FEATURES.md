# Функциональность пагинации сообщений

## Обзор

Добавлена возможность просмотра истории сообщений с пагинацией для решения проблемы с большими диалогами, где нельзя было листать историю сообщений.

## Новые возможности

### 1. Пагинация сообщений
- **Загрузка по частям**: Сообщения загружаются по 20 штук за раз
- **Кнопка "Загрузить еще"**: Позволяет загрузить предыдущие сообщения
- **Автоматическая прокрутка**: Сохраняет позицию при загрузке старых сообщений

### 2. Навигация по истории
- **Кнопка "Загрузить еще сообщения"**: В начале чата для загрузки старых сообщений
- **Индикатор загрузки**: Показывает процесс загрузки сообщений
- **Состояние "Больше сообщений нет"**: Когда достигнут конец истории

### 3. Автоматическое обновление
- **Проверка новых сообщений**: Каждые 3 секунды
- **Индикатор новых сообщений**: Показывается, если пользователь не внизу чата
- **Автоматическая прокрутка**: К новым сообщениям, если пользователь был внизу

### 4. Разделители дат
- **Автоматические разделители**: "Сегодня", "Вчера", конкретная дата
- **Визуальное разделение**: Помогает ориентироваться в истории сообщений

### 5. Улучшенный UX
- **Отслеживание позиции прокрутки**: Не прокручивает автоматически, если пользователь читает историю
- **Плавные анимации**: Для всех элементов интерфейса
- **Адаптивный дизайн**: Работает на всех устройствах

## Техническая реализация

### Переменные состояния
```javascript
let messagePage = 0;           // Текущая страница
let messagesPerPage = 20;      // Сообщений на страницу
let hasMoreMessages = true;    // Есть ли еще сообщения
let isLoadingMessages = false; // Идет ли загрузка
let allMessages = [];          // Кэш всех сообщений
let isScrolledToBottom = true; // Пользователь внизу чата
```

### Основные функции

#### `loadMessagesWithPagination(conversationId, loadMore)`
Загружает сообщения с пагинацией:
- `conversationId` - ID диалога
- `loadMore` - загружать ли дополнительные сообщения

#### `loadNewMessages(conversationId)`
Проверяет и загружает новые сообщения

#### `prependMessages(messages)`
Добавляет сообщения в начало чата с сохранением позиции прокрутки

#### `showNewMessagesIndicator(count)`
Показывает индикатор новых сообщений

### CSS классы

#### `.load-more-btn`
Контейнер для кнопки "Загрузить еще"

#### `.load-more-button`
Стилизованная кнопка загрузки

#### `.loading-indicator`
Индикатор загрузки

#### `.new-messages-indicator`
Индикатор новых сообщений

#### `.date-separator`
Разделитель дат

## Использование

### Для пользователей
1. Откройте чат с поддержкой
2. Если есть старые сообщения, нажмите "Загрузить еще сообщения"
3. Прокручивайте историю вверх и вниз
4. Новые сообщения будут появляться автоматически

### Для администраторов
1. Откройте панель администратора
2. Выберите диалог с пользователем
3. Используйте те же функции пагинации для просмотра истории

## Преимущества

1. **Производительность**: Загрузка по частям снижает нагрузку на сервер
2. **Удобство**: Легко ориентироваться в больших диалогах
3. **Реактивность**: Мгновенная обратная связь при отправке сообщений
4. **Надежность**: Автоматическое восстановление при ошибках
5. **Масштабируемость**: Работает с любым количеством сообщений

## Совместимость

- ✅ Telegram Web App
- ✅ Все современные браузеры
- ✅ Мобильные устройства
- ✅ Desktop приложения

## Будущие улучшения

1. **Поиск по сообщениям**: Поиск по тексту в истории
2. **Фильтрация**: По дате, типу сообщения
3. **Экспорт**: Сохранение истории диалога
4. **Закладки**: Сохранение важных сообщений
5. **Статистика**: Аналитика по сообщениям
